<!DOCTYPE html>
<html lang="en" dir="ltr">
 
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>Concierge OS ‚Äì Guest Experience</title>
    <!-- Theme color definitions for progressive web app installations -->
    <!-- Updated theme colour to match the new blue palette -->
    <meta name="theme-color" content="#502274" />
  <!-- Leaflet CSS for interactive map support (referenced from Prototype 6) -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
  />
    <meta name="color-scheme" content="light dark" />
    <style>
     
      :root {
       
        --brand-primary: #502274; /* deep violet */
        --brand-secondary: #8b5cf6; /* bright lilac */
        --accent: #ff6b6b; /* coral accent */
        --danger: #e74c3c; /* rich red */
        --success: #00b894; /* teal */
        --warning: #f0a500; /* golden amber */
        --accent: #e3b505; /* gold accent (overridden by JS if guest selects a custom accent colour) */
        --danger: #d62839; /* wine red */
        --success: #007f5f; /* emerald */
        --warning: #f7b32b; /* amber */
        --bg: #f9fafb;
        --bg-alt: #edf2f7;
        --fg: #0a1f33;
        --fg-soft: #24364e;
        --fg-muted: #64748b;
        --card: #ffffff;
        --card-alt: #f1f5f9;
        --border: #d1d5db;
        --border-alt: #cbd5e1;
        --shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        --radius: 0.9rem;
        --radius-sm: 0.5rem;
        --radius-lg: 1.4rem;
        --font-sans: 'Inter', ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto,
          'Helvetica Neue', Arial, 'Noto Sans', sans-serif;
        --font-mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
          'Liberation Mono', 'Courier New', monospace;
        --transition-speed: 160ms;
        --transition-ease: cubic-bezier(0.2, 0.7, 0.2, 1);
      }
      
      body[data-theme='dark'] {
        
        --bg: #180a2e;
        --bg-alt: #210f44;
        --fg: #ede9fe;
        --fg-soft: #dcd4fc;
        --fg-muted: #b6a7e8;
        --card: #1f133f;
        --card-alt: #2a1b55;
        --border: #3a257a;
        --border-alt: #443094;
        --shadow: 0 6px 16px rgba(0, 0, 0, 0.6);
      }
      
      body[data-contrast='high'] {
        --bg: #ffffff;
        --bg-alt: #f1f5f9;
        --fg: #000000;
        --fg-soft: #111827;
        --fg-muted: #374151;
        --border: #4b5563;
        --border-alt: #6b7280;
        /* Maintain brand colours but bump up brightness */
        --brand-primary: #004a8d;
        --brand-secondary: #008bbf;
        --accent: #eab308;
      }
      /* Large text mode simply scales up base font size. This is applied to
         the root element so all descendants inherit it. */
      html[data-text='large'] {
        font-size: 18px;
      }
      /* Base styles applied universally */
      html,
      body {
        margin: 0;
        padding: 0;
        height: 100%;
        font-family: var(--font-sans);
        background: var(--bg);
        color: var(--fg);
      }
      *,
      *::before,
      *::after {
        box-sizing: border-box;
      }
      a {
        text-decoration: none;
        color: var(--brand-secondary);
        transition: color var(--transition-speed) var(--transition-ease);
      }
      a:hover {
        color: var(--brand-primary);
      }
      /* Buttons */
      button {
        font: inherit;
        border: none;
        cursor: pointer;
        border-radius: var(--radius-sm);
        padding: 0.4rem 0.8rem;
        transition: background var(--transition-speed) var(--transition-ease),
          transform var(--transition-speed) var(--transition-ease);
      }

      /* Styled select elements for language and currency. Matches the look of the
         toggles but retains native dropdown functionality. */
      .control-select {
        appearance: none;
        -moz-appearance: none;
        -webkit-appearance: none;
        position: relative;
        padding: 0.35rem 1.6rem 0.35rem 0.8rem;
        border-radius: 2rem;
        background: linear-gradient(120deg, var(--brand-secondary), var(--brand-primary));
        color: #fff;
        font-size: 0.8rem;
        font-weight: 600;
        border: none;
        box-shadow: 0 3px 8px rgba(0, 0, 0, 0.2);
        cursor: pointer;
        transition: transform var(--transition-speed) var(--transition-ease),
          box-shadow var(--transition-speed) var(--transition-ease);
      }
      .control-select:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.25);
      }
      /* Use a down arrow as a background icon for selects */
      .control-select::-ms-expand {
        display: none;
      }
      .control-select {
        background-image: url("data:image/svg+xml,%3Csvg width='12' height='12' viewBox='0 0 24 24' fill='%23ffffff' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M7 10l5 5 5-5H7z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 0.6rem center;
        background-size: 0.7rem;
      }
      /* Options should have dark text on light background */
      .control-select option {
        color: var(--fg);
        background: #ffffff;
      }
      button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      .btn-primary {
        background: var(--brand-primary);
        color: #fff;
      }
      .btn-primary:hover {
        background: var(--brand-secondary);
        transform: translateY(-2px);
      }
      .btn-secondary {
        background: var(--border);
        color: var(--fg);
      }
      .btn-secondary:hover {
        background: var(--border-alt);
      }
      /* App bar at the top of the screen */
      header.appbar {
        position: sticky;
        top: 0;
        z-index: 1000;
        width: 100%;
        background: linear-gradient(95deg, var(--brand-primary), var(--brand-secondary));
        color: #fff;
        box-shadow: var(--shadow);
      }
      .appbar-inner {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0.6rem 1rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      .brand {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-weight: 900;
        font-size: 1.4rem;
        letter-spacing: -0.02em;
      }
      .brand .sub {
        font-size: 0.8rem;
        font-weight: 500;
      }
      /* Controls for theme/text/contrast toggles */
      .controls {
        display: flex;
        align-items: center;
        gap: 0.4rem;
      }
      .control-toggle {
        position: relative;
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        padding: 0.4rem 0.8rem 0.4rem 2.2rem;
        border-radius: 2rem;
        background: linear-gradient(120deg, var(--brand-secondary), var(--brand-primary));
        color: #fff;
        font-size: 0.8rem;
        font-weight: 600;
        border: none;
        box-shadow: 0 3px 8px rgba(0, 0, 0, 0.2);
        cursor: pointer;
        overflow: hidden;
        transition: transform var(--transition-speed) var(--transition-ease),
          box-shadow var(--transition-speed) var(--transition-ease);
      }
      .control-toggle:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.25);
      }
      .control-toggle::before {
        content: attr(data-icon);
        position: absolute;
        left: 0.8rem;
        top: 50%;
        transform: translateY(-50%);
        font-size: 1.1rem;
      }
      .control-toggle:hover {
        background: var(--border-alt);
      }
      /* Main layout grid. Uses two columns on large screens and a single
         column on narrow screens */
      main {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
        max-width: 1200px;
        padding: 1rem;
        margin: 0 auto;
      }
      @media (max-width: 900px) {
        main {
          grid-template-columns: 1fr;
        }
      }
      /* Reusable card component */
      .card {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        padding: 1rem;
        display: flex;
        flex-direction: column;
        gap: 0.6rem;
      }
      .card h2 {
        margin: 0;
        font-size: 1.1rem;
        font-weight: 700;
      }
      .card p {
        margin: 0;
        color: var(--fg-muted);
        line-height: 1.4;
      }
      /* Floating action button for the chatbot */
      .fab {
        position: fixed;
        right: 1.2rem;
        bottom: 1.2rem;
        width: 56px;
        height: 56px;
        border-radius: 50%;
        background: radial-gradient(
          120% 120% at 70% 20%,
          var(--brand-primary) 0%,
          var(--brand-secondary) 70%
        );
        color: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.4rem;
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);
        cursor: pointer;
        z-index: 1001;
      }

      /*
        ============================
        PART 7 STYLES ‚Äì PREMIUM APP FEEL
        -------------------------------
        The next section introduces styles to make the interface feel more like
        a 2025‚Äì2026 premium mobile app. Cards have slightly larger radius,
        subtle gradients and increased padding. A bottom navigation bar
        provides quick access to key sections. The chat interface now
        supports multiple agents with toggle buttons and uses larger,
        friendlier bubbles.
      */
      /* Increase card roundness and shadow for a modern look */
      .card {
        border-radius: var(--radius-lg);
        background: linear-gradient(180deg, var(--card) 0%, var(--card-alt) 100%);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
      }
      /* Bottom navigation bar */
      .bottom-nav {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 60px;
        background: var(--bg);
        border-top: 1px solid var(--border);
        display: flex;
        align-items: center;
        justify-content: space-around;
        z-index: 1000;
      }
      .bottom-nav button {
        background: none;
        border: none;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: var(--fg);
        font-size: 0.8rem;
        gap: 0.2rem;
        cursor: pointer;
      }
      .bottom-nav button.active {
        color: var(--brand-secondary);
      }
      .bottom-nav button span.icon {
        font-size: 1.2rem;
      }
      /* Chat agent selector buttons */
      .chat-agents {
        display: flex;
        gap: 0.4rem;
        padding: 0.4rem;
        background: var(--card);
        border-bottom: 1px solid var(--border);
      }
      .chat-agents button {
        flex: 1;
        border: none;
        border-radius: var(--radius-sm);
        padding: 0.4rem 0;
        background: var(--card-alt);
        color: var(--fg);
        font-weight: 600;
        cursor: pointer;
        transition: background var(--transition-speed) var(--transition-ease);
      }
      .chat-agents button.active {
        background: var(--brand-primary);
        color: #fff;
      }
      /* Larger, softer chat bubbles */
      .chat-bubble {
        border-radius: var(--radius-lg);
        padding: 0.7rem 1rem;
        font-size: 0.95rem;
      }

      /* Subtle fade-up animation for cards to give a modern feel on load */
      @keyframes fadeUp {
        from {
          opacity: 0;
          transform: translateY(12px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .card {
        animation: fadeUp 0.5s ease both;
      }
      .chat-bubble.bot {
        background: var(--card-alt);
      }
      .chat-bubble.user {
        background: var(--brand-secondary);
        color: #fff;
      }
      .fab:hover {
        filter: brightness(1.1);
      }
      /* Chat interface container that slides into view when the FAB is clicked */
      .chat-container {
        position: fixed;
        right: 1.2rem;
        bottom: 4.8rem;
        width: min(360px, 90vw);
        max-height: 440px;
        border: 1px solid var(--border);
        border-radius: var(--radius);
        background: var(--card);
        box-shadow: var(--shadow);
        display: none;
        flex-direction: column;
        overflow: hidden;
        z-index: 1001;
      }
      .chat-header {
        background: linear-gradient(95deg, var(--brand-primary), var(--brand-secondary));
        color: #fff;
        padding: 0.6rem;
        font-weight: 700;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      .chat-log {
        padding: 0.6rem;
        flex: 1;
        overflow-y: auto;
        background: var(--card-alt);
      }
      .chat-input {
        display: flex;
        gap: 0.4rem;
        padding: 0.6rem;
        background: var(--card);
        border-top: 1px solid var(--border);
      }
      .chat-input input {
        flex: 1;
        border: 1px solid var(--border);
        border-radius: var(--radius-sm);
        padding: 0.5rem 0.6rem;
        background: var(--bg-alt);
        color: var(--fg);
      }
      .chat-input button {
        background: var(--brand-primary);
        color: #fff;
        border-radius: var(--radius-sm);
        padding: 0.5rem 0.8rem;
      }
      .chat-bubble {
        margin: 0.3rem 0;
        padding: 0.55rem 0.8rem;
        border-radius: var(--radius);
        max-width: 85%;
        word-wrap: break-word;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }
      .chat-bubble.user {
        background: var(--brand-primary);
        color: #fff;
        margin-left: auto;
      }
      .chat-bubble.bot {
        background: var(--border-alt);
        color: var(--fg);
      }

      /*
        ============================
        PART 2 STYLES
        ----------------------------
        The following styles support the additional feature cards added in
        part 2. These include a dining menu list, housekeeping action list,
        stay information widgets and toast notifications. Lists use flex
        layouts to align content neatly and buttons leverage the global
        button styles defined earlier.
      */
      /* Generic list containers for menus and action buttons */
      .menu-list,
      .action-list {
        list-style: none;
        margin: 0;
        padding: 0;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }
      /* Individual menu items with pricing */
      .menu-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 0.5rem;
        padding: 0.5rem;
        background: var(--card-alt);
        border: 1px solid var(--border);
        border-radius: var(--radius-sm);
      }
      .menu-item .info {
        display: flex;
        flex-direction: column;
        flex: 1;
      }
      .menu-item .name {
        font-weight: 600;
      }
      .menu-item .desc {
        font-size: 0.85rem;
        color: var(--fg-muted);
      }
      .price {
        font-weight: 700;
        margin-right: 0.8rem;
      }
      /* Toast container and animation */
      .toast-container {
        position: fixed;
        top: 1.2rem;
        right: 1.2rem;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        z-index: 1002;
      }
      .toast {
        background: var(--brand-primary);
        color: #fff;
        padding: 0.6rem 1rem;
        border-radius: var(--radius-sm);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        animation: fadeOut 4s forwards;
      }
      @keyframes fadeOut {
        0% {
          opacity: 1;
        }
        80% {
          opacity: 1;
        }
        100% {
          opacity: 0;
        }
      }

      /*
        ============================
        PART 4 STYLES
        ----------------------------
        Styles for the notification bell and tray, services actions and
        folio. The bell includes a small badge showing the number of
        notifications. The tray slides down from the top right and lists
        notifications chronologically.
      */
      .notif-bell {
        position: relative;
        padding: 0.3rem 0.5rem;
        cursor: pointer;
        font-size: 1.2rem;
        line-height: 1;
        user-select: none;
      }
      .notif-count {
        position: absolute;
        top: -0.2rem;
        right: -0.1rem;
        background: var(--danger);
        color: #fff;
        font-size: 0.7rem;
        border-radius: 50%;
        width: 1rem;
        height: 1rem;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .notif-tray {
        position: fixed;
        top: 3.2rem;
        right: 1rem;
        width: min(320px, 90vw);
        max-height: 320px;
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        display: none;
        flex-direction: column;
        overflow-y: auto;
        z-index: 1003;
      }
      .notif-head {
        padding: 0.6rem;
        font-weight: 700;
        border-bottom: 1px solid var(--border);
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      .notif-item {
        display: flex;
        gap: 0.5rem;
        padding: 0.6rem;
        border-bottom: 1px solid var(--border-alt);
        align-items: flex-start;
      }
      .notif-item:last-child {
        border-bottom: none;
      }
      .notif-item .time {
        font-size: 0.75rem;
        color: var(--fg-muted);
      }

      /*
        ============================
        PART 3 STYLES
        ----------------------------
        Styles specific to the profile form, order summary and map card.
        Form groups stack labels with inputs and selects. Summary lists
        align names and prices neatly. The map card uses inline styles
        defined in the HTML for height and layout.
      */
      .form-group {
        display: flex;
        flex-direction: column;
        gap: 0.3rem;
      }
      .form-group label {
        font-weight: 600;
      }
      .form-group input,
      .form-group select {
        border: 1px solid var(--border);
        border-radius: var(--radius-sm);
        padding: 0.5rem 0.6rem;
        background: var(--bg-alt);
        color: var(--fg);
      }
      .summary-list {
        list-style: none;
        margin: 0;
        padding: 0;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }

      /* Activity log styles. Each log entry is displayed with the
         message aligned left and a timestamp on the right. */
      .activity-list {
        list-style: none;
        margin: 0;
        padding: 0;
        display: flex;
        flex-direction: column;
      }
      .activity-list li {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        padding: 0.4rem 0;
        border-bottom: 1px solid var(--border);
        font-size: 0.9rem;
      }
      .activity-list li:last-child {
        border-bottom: none;
      }
      .activity-list .time {
        color: var(--fg-muted);
        font-size: 0.8rem;
        margin-left: 1rem;
      }

      /* Events card styling */
      .events-list li {
        border-bottom: 1px solid var(--border);
        padding: 0.6rem 0;
        display: flex;
        flex-direction: column;
        gap: 0.3rem;
      }
      .events-list li:last-child {
        border-bottom: none;
      }
      .events-list .event-title {
        font-weight: 600;
      }
      .events-list .event-date {
        font-size: 0.85rem;
        color: var(--fg-muted);
      }
      .events-list button {
        align-self: flex-start;
        margin-top: 0.4rem;
      }
      .summary-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .total-line {
        margin-top: 0.5rem;
        font-weight: 700;
        text-align: right;
      }

      /* KPI styling inside the dashboard card */
      .kpi strong {
        font-size: 1.2rem;
        font-weight: 700;
        color: var(--fg-soft);
      }

      /*
        ============================
        PART 5 STYLES
        ----------------------------
        The following styles support new user-centric features introduced
        in this part: wake-up scheduling, reminders and itinerary planning.
        These cards use familiar layouts from earlier cards and extend
        them with form controls. Reminder and itinerary lists present
        items with checkboxes and action buttons for a consistent
        experience. Dragging functionality is applied to the chat header
        to allow repositioning on screen.
      */
      /* Reminder and itinerary list styling */
      .reminder-list,
      .itinerary-list {
        list-style: none;
        margin: 0;
        padding: 0;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }
      .reminder-item,
      .itinerary-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: var(--card-alt);
        border: 1px solid var(--border);
        border-radius: var(--radius-sm);
        padding: 0.5rem;
      }
      .reminder-item span,
      .itinerary-item span {
        flex: 1;
      }
      .reminder-item button,
      .itinerary-item button {
        margin-left: 0.5rem;
        font-size: 0.8rem;
        padding: 0.3rem 0.5rem;
      }
      /* Chat header drag cursor */
      .chat-header {
        cursor: move;
      }
    </style>
  </head>
  <body>
    <!--
      Application bar showing brand and accessibility controls.
      The controls reflect the current state stored in localStorage and allow
      guests to toggle between light/dark mode, high contrast mode and large
      text. Additional actions (like opening the settings page) can be added
      later. The .data attribute on the body is manipulated through
      JavaScript.
    -->
    <header class="appbar">
      <div class="appbar-inner">
        <div class="brand">
          MORPHO‚ÄîThe AI Concierge
          <!-- Removed the old ‚ÄúGuest Experience‚Äù tagline for a cleaner header -->
        </div>
        <div class="controls">
          <!-- Enhanced toggles with icons and vibrant backgrounds for a unique feel -->
          <button class="control-toggle" id="themeToggle" aria-label="Toggle theme" data-icon="üåì">Light</button>
          <button class="control-toggle" id="contrastToggle" aria-label="Toggle contrast" data-icon="‚ö°">Contrast</button>
          <button class="control-toggle" id="textToggle" aria-label="Toggle text size" data-icon="üî†">Text</button>
          <!-- Language selection allows guests to switch between supported languages. -->
          <select id="langSelect" class="control-select" aria-label="Select language">
            <option value="en">English</option>
            <option value="es">Espa√±ol</option>
          </select>
          <!-- Currency selection for price display -->
          <select id="currencySelect" class="control-select" aria-label="Select currency">
            <option value="EUR">EUR</option>
            <option value="USD">USD</option>
            <option value="GBP">GBP</option>
          </select>
          <!-- Notification bell shows the number of unread notifications -->
          <div class="notif-bell" id="notifBell" aria-label="Notifications">
            üîî<span id="notifCount" class="notif-count">0</span>
          </div>
        </div>
      </div>
    </header>
    <!-- Toast container for transient notifications -->
    <div id="toastContainer" class="toast-container"></div>

    <!-- Notification tray shows past notifications and can be toggled via the bell icon -->
    <div id="notifTray" class="notif-tray">
      <div class="notif-head">
        <span>Notifications</span>
        <button class="btn-secondary" id="clearNotifBtn" style="font-size:0.8rem; padding:0.2rem 0.5rem;">Clear</button>
      </div>
      <div id="notifList"></div>
    </div>
    <!-- Main content area. Feature tiles will be inserted here in later parts. -->
    <main>
      <div class="card" id="welcomeCard">
        <h2 id="welcomeHeading">Welcome</h2>
        <p id="welcomeMessage">Loading your experience‚Ä¶</p>
      </div>
      <div class="card" id="featuresOverview">
        <h2 id="featuresHeading">Features Overview</h2>
        <p>
          More cards with interactive features will appear here as we build
          subsequent parts. You can expect dining options, local maps,
          housekeeping requests, taxi bookings, spa appointments and many
          other services to delight your stay.
        </p>
      </div>

      <!-- Dashboard card. Displays real-time KPIs such as local and
           home country time, days remaining in the stay and total spend.
           Also features a daily tip to delight guests. -->
      <div class="card" id="dashboardCard">
        <h2 id="dashboardHeading">Dashboard</h2>
        <div class="kpis" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap:0.6rem;">
          <div class="kpi" style="display:flex; flex-direction:column; gap:0.2rem;">
            <span id="localTimeLabel">Local Time</span>
            <strong id="localTimeValue">--:--:--</strong>
          </div>
          <div class="kpi" style="display:flex; flex-direction:column; gap:0.2rem;">
            <span id="homeTimeLabel">Home Time</span>
            <strong id="homeTimeValue">--:--:--</strong>
          </div>
          <div class="kpi" style="display:flex; flex-direction:column; gap:0.2rem;">
            <span id="daysLeftLabel">Days Left</span>
            <strong id="daysLeftValue">0</strong>
          </div>
          <div class="kpi" style="display:flex; flex-direction:column; gap:0.2rem;">
            <span id="totalSpendLabel">Total Spend</span>
            <strong id="totalSpendValue">‚Ç¨0.00</strong>
          </div>
          <div class="kpi" style="display:flex; flex-direction:column; gap:0.2rem;">
            <span id="remindersLabel">Reminders</span>
            <strong id="remindersValue">0</strong>
          </div>
          <div class="kpi" style="display:flex; flex-direction:column; gap:0.2rem;">
            <span id="itineraryLabel">Itinerary</span>
            <strong id="itineraryValue">0</strong>
          </div>
        </div>
        <div id="dailyTipContainer" style="margin-top:0.6rem;">
          <span id="dailyTipLabel">Daily Tip</span>: <span id="dailyTipText"></span>
        </div>
      </div>

      <!-- Dining menu card. Items are rendered dynamically via JavaScript -->
      <div class="card" id="menuCard">
        <h2 id="diningHeading">Dining</h2>
        <!-- Search input allows guests to filter menu items by name -->
        <input type="text" id="menuSearch" placeholder="Search menu‚Ä¶" style="width:100%; padding:0.4rem 0.6rem; margin-bottom:0.6rem; border:1px solid var(--border); border-radius:var(--radius-sm); background:var(--card-alt); color:var(--fg);" />
        <ul id="menuList" class="menu-list"></ul>
      </div>

      <!-- Housekeeping card with quick actions -->
      <div class="card" id="housekeepingCard">
        <h2 id="housekeepingHeading">Housekeeping</h2>
        <div class="action-list">
          <button class="btn-primary" data-action="clean">Clean room</button>
          <button class="btn-primary" data-action="towels">Fresh towels</button>
          <button class="btn-primary" data-action="wake">Wake-up call</button>
        </div>
      </div>

      <!-- Stay information card showing room and dates -->
      <div class="card" id="stayCard">
        <h2 id="stayHeading">Stay Information</h2>
        <p>Room <span id="roomNumber">‚Äî</span></p>
        <p id="stayDateRange">‚Äî</p>
        <div class="action-list">
          <button class="btn-secondary" id="unlockBtn">Unlock door</button>
          <button class="btn-secondary" id="extendBtn">Extend stay</button>
        </div>
      </div>

      <!-- Profile management card. Allows guests to update their name,
           dietary preferences, allergies, voice assistant and network
           settings. -->
      <div class="card" id="profileCard">
        <h2 id="profileHeading">Profile</h2>
        <div class="form-group">
          <label for="profileName">Name</label>
          <input id="profileName" type="text" />
        </div>
        <div class="form-group">
          <label for="profileDiet">Dietary preference</label>
          <select id="profileDiet">
            <option value="all">No preference</option>
            <option value="vegan">Vegan</option>
            <option value="vegetarian">Vegetarian</option>
            <option value="gluten-free">Gluten‚Äëfree</option>
          </select>
        </div>
        <div class="form-group">
          <label for="profileAllergies">Allergies</label>
          <input id="profileAllergies" type="text" placeholder="e.g. peanuts" />
        </div>
        <div class="form-group">
          <label><input id="profileVoice" type="checkbox" /> Enable voice assistant</label>
        </div>
        <div class="form-group">
          <label><input id="profileNetwork" type="checkbox" /> Enable network features</label>
        </div>
        <div class="form-group">
          <label for="profileTimeZone">Home timezone</label>
          <select id="profileTimeZone">
            <option value="UTC">UTC</option>
            <option value="Europe/Dublin">Europe/Dublin</option>
            <option value="America/New_York">America/New_York</option>
            <option value="Europe/London">Europe/London</option>
            <option value="Asia/Tokyo">Asia/Tokyo</option>
            <option value="Australia/Sydney">Australia/Sydney</option>
          </select>
        </div>
      <!-- Accent colour picker allows guests to customise the accent hue of the interface. This
           preference is saved in localStorage and applied to the CSS variable --accent. -->
      <div class="form-group">
        <label for="profileAccent" id="accentColorLabel">Accent colour</label>
        <input type="color" id="profileAccent" value="#e3b505" />
      </div>
        <button class="btn-primary" id="profileSave">Save profile</button>
      </div>

      <!-- Orders summary card. Displays the items added to the order and
           calculates the total. Guests can clear their order from here. -->
      <div class="card" id="orderSummaryCard">
        <h2 id="ordersHeading">Your Orders</h2>
        <ul id="orderSummaryList" class="summary-list"></ul>
        <div id="orderTotal" class="total-line"></div>
        <!-- Estimated delivery time will be displayed here if there are pending orders -->
        <div id="orderEstimate" class="estimate-line" style="font-size:0.85rem; color:var(--fg-muted);"></div>
        <button class="btn-secondary" id="clearOrdersBtn">Clear orders</button>
      </div>

      <!-- Map & Weather card. When offline, a simple schematic map is drawn
           onto a canvas. When network features are enabled, the same canvas
           is reused to display basic location coordinates and a marker. A
           weather readout appears below. -->
      <div class="card" id="mapCard">
        <h2 id="mapHeading">Map &amp; Weather</h2>
        <div id="mapContainer" style="position:relative; height:180px; border-radius:var(--radius); overflow:hidden; background:var(--card-alt);">
          <!-- Canvas for offline and fallback map rendering -->
          <canvas id="mapCanvas" width="360" height="180" style="width:100%; height:100%;"></canvas>
        <!-- Leaflet map container for interactive maps when network is enabled -->
        <div id="leafletMap" style="width:100%; height:100%; display:none;"></div>
          <!-- Overlay message shown only when network features are disabled -->
          <div id="mapOverlay" style="position:absolute; top:0; left:0; width:100%; height:100%; display:flex; align-items:center; justify-content:center; color:var(--fg-muted); font-size:0.85rem;"></div>
        </div>
        <div id="weatherContainer" style="margin-top:0.8rem;">Weather: <span id="weatherInfo">N/A</span></div>
      </div>

      <!-- Services card with quick access to various concierge services -->
      <div class="card" id="servicesCard">
        <h2 id="servicesHeading">Services</h2>
        <div class="action-list">
          <button class="btn-primary" data-service="spa">Spa appointment</button>
          <button class="btn-primary" data-service="taxi">Book taxi</button>
          <button class="btn-primary" data-service="late-checkout">Late checkout</button>
          <button class="btn-primary" data-service="wake-up">Custom wake‚Äëup</button>
        </div>
      </div>

      <!-- Folio card summarises all purchases and provides a payment action -->
      <div class="card" id="folioCard">
        <h2 id="folioHeading">Folio</h2>
        <ul id="folioList" class="summary-list"></ul>
        <div id="folioTotal" class="total-line"></div>
        <button class="btn-primary" id="payNowBtn">Pay now</button>
      </div>


      <!-- Room controls card. Allows guests to adjust in-room amenities
           such as lighting, drapes and air conditioning. Values are
           persisted locally and actions are logged. -->
      <div class="card" id="roomControlsCard">
        <h2 id="roomControlsHeading">Room Controls</h2>
        <div class="form-group">
          <label><input type="checkbox" id="lightsToggle" /> Lights on</label>
        </div>
        <div class="form-group">
          <label><input type="checkbox" id="drapesToggle" /> Drapes open</label>
        </div>
        <div class="form-group">
          <label for="acSlider">AC Temperature: <span id="acTempLabel">22</span>¬∞C</label>
          <input type="range" id="acSlider" min="16" max="30" step="1" />
        </div>
      </div>

      <!-- Feedback card. Guests can submit a rating and optional comments
           about their stay. Submitted feedback is stored locally. -->
      <div class="card" id="feedbackCard">
        <h2 id="feedbackHeading">Feedback</h2>
        <div class="form-group">
          <label for="feedbackRating">Rating (1‚Äì5)</label>
          <select id="feedbackRating">
            <option value="">Select rating</option>
            <option value="5">5 ‚Äì Excellent</option>
            <option value="4">4 ‚Äì Very good</option>
            <option value="3">3 ‚Äì Good</option>
            <option value="2">2 ‚Äì Fair</option>
            <option value="1">1 ‚Äì Poor</option>
          </select>
        </div>
        <div class="form-group">
          <label for="feedbackComment">Comments</label>
          <textarea id="feedbackComment" rows="3" style="width:100%; border:1px solid var(--border); border-radius:var(--radius-sm); padding:0.5rem; background:var(--bg-alt); color:var(--fg);"></textarea>
        </div>
        <button class="btn-primary" id="feedbackSubmit">Submit feedback</button>
      </div>

      <!-- Local events card. Showcases upcoming local events or attractions.
           Guests can tap to indicate interest. -->
      <div class="card" id="eventsCard">
        <h2 id="eventsHeading">Local Events</h2>
        <ul id="eventsList" class="events-list" style="list-style:none; margin:0; padding:0;"></ul>
      </div>

      <!-- News card. Presents a short list of recent hotel or local news
           headlines to keep guests informed. -->
      <div class="card" id="newsCard">
        <h2 id="newsHeading">News</h2>
        <ul id="newsList" class="news-list" style="list-style:none; margin:0; padding:0;"></ul>
      </div>

      <!-- Shuttle schedule card. Shows the next departures for hotel
           shuttles to destinations like the airport or downtown. -->
      <div class="card" id="shuttleCard">
        <h2 id="shuttleHeading">Shuttle Schedule</h2>
        <ul id="shuttleList" class="shuttle-list" style="list-style:none; margin:0; padding:0;"></ul>
      </div>

      <!-- Wake-up call scheduler. Guests can set a custom wake-up time
           which will be stored and used to trigger a notification. This
           replaces the simple wake-up call buttons found in earlier
           versions. -->
      <div class="card" id="wakeCard">
        <h2 id="wakeHeading">Wake-up Call</h2>
        <p id="wakeStatus">No wake-up call set.</p>
        <div class="form-group">
          <label for="wakeTime">Select time</label>
          <input id="wakeTime" type="time" />
        </div>
        <div class="action-list" style="flex-direction:row; gap:0.5rem; justify-content:flex-start;">
          <button class="btn-primary" id="setWakeBtn">Set wake-up</button>
          <button class="btn-secondary" id="clearWakeBtn">Clear wake-up</button>
        </div>
      </div>

      <!-- Reminders card. Allows guests to add personal reminders for
           activities, medications or other tasks. Reminders trigger a
           notification when due. -->
      <div class="card" id="reminderCard">
        <h2 id="reminderHeading">Reminders</h2>
        <div class="form-group">
          <label for="reminderTitle">Reminder title</label>
          <input id="reminderTitle" type="text" placeholder="e.g. Meeting with client" />
        </div>
        <div class="form-group">
          <label for="reminderTime">Time</label>
          <input id="reminderTime" type="datetime-local" />
        </div>
        <button class="btn-primary" id="addReminderBtn">Add reminder</button>
        <ul id="reminderList" class="reminder-list"></ul>
      </div>

      <!-- Itinerary planner. Guests can build their itinerary by adding
           planned activities with dates and locations. This helps keep
           track of their schedule during the stay. -->
      <div class="card" id="itineraryCard">
        <h2 id="itineraryHeading">Itinerary</h2>
        <div class="form-group">
          <label for="itineraryTitle">Event name</label>
          <input id="itineraryTitle" type="text" placeholder="e.g. Museum visit" />
        </div>
        <div class="form-group">
          <label for="itineraryTime">Date &amp; time</label>
          <input id="itineraryTime" type="datetime-local" />
        </div>
        <div class="form-group">
          <label for="itineraryLocation">Location</label>
          <input id="itineraryLocation" type="text" placeholder="e.g. National Gallery" />
        </div>
        <button class="btn-primary" id="addItineraryBtn">Add event</button>
        <ul id="itineraryList" class="itinerary-list"></ul>
      </div>

      <!-- Activity log card. Moved to the end of the main content to keep
           actionable features near the top. Displays a history of user
           actions such as orders, service requests and other interactions.
           Guests can review or clear their activity log at any time. -->
      <div class="card" id="activityCard">
        <h2 id="activityHeading">Activity Log</h2>
        <div class="action-list" style="justify-content:flex-end; margin-bottom:0.4rem;">
          <button class="btn-secondary" id="clearActivityBtn" style="font-size:0.8rem; padding:0.2rem 0.5rem;">Clear log</button>
        </div>
        <ul id="activityList" class="activity-list" style="list-style:none; padding:0; margin:0;"></ul>
      </div>
    </main>
    <!-- Floating action button and chat container. The chat opens when the
         button is clicked and will remain anchored to the bottom right of
         the viewport. -->
    <div class="fab" id="chatFab" aria-label="Open chat">üí¨</div>
    <div class="chat-container" id="chatContainer">
      <div class="chat-header" id="chatHeader">
        <!-- Chat title displays the MORPHO brand followed by the active agent name -->
        <span id="chatTitle">MORPHO ‚Äì Concierge</span>
        <button id="chatClose" aria-label="Close chat">√ó</button>
      </div>
      <!-- Agent selector row. Each button switches the active agent for
           the chatbot. -->
      <div class="chat-agents" id="chatAgents">
        <button data-agent="concierge" class="active">Concierge</button>
        <button data-agent="explorer">Explorer</button>
        <button data-agent="support">Support</button>
      </div>
      <div class="chat-log" id="chatLog"></div>
      <div class="chat-input">
        <input type="text" id="chatInput" placeholder="Type a message‚Ä¶" autocomplete="off" />
        <button id="chatSend">Send</button>
      </div>
    </div>

    <!-- Bottom navigation bar for an app-like experience. Each button
         scrolls to a key section of the page. Icons use emoji for
         simplicity; these can be replaced with SVGs if needed. -->
    <nav class="bottom-nav" id="bottomNav">
      <button data-target="welcomeCard" class="active"><span class="icon">üè†</span><span>Home</span></button>
      <button data-target="menuCard"><span class="icon">üçΩÔ∏è</span><span>Dining</span></button>
      <button data-target="servicesCard"><span class="icon">üõéÔ∏è</span><span>Services</span></button>
      <button data-target="profileCard"><span class="icon">üë§</span><span>Profile</span></button>
    </nav>
    <!-- JavaScript to manage state, accessibility toggles and chat logic. -->
  <!-- Leaflet JS library -->
  <script
    src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
  ></script>
  <script>
      //
      // Part 1: Core State Management and Accessibility Controls
      //---------------------------------------------------------
      // We define a simple state object that mirrors the values stored in
      // localStorage. Upon page load we initialise this state, apply it to
      // the document and update the UI (buttons etc.). Any subsequent
      // changes to state will be persisted to localStorage ensuring that
      // guests see the same theme, contrast and text size on return visits.

      // Declare default state values
      const defaultState = {
        theme: localStorage.getItem('concierge-theme') ||
          (matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light'),
        contrast: localStorage.getItem('concierge-contrast') || 'normal',
        text: localStorage.getItem('concierge-text') || 'normal',
        name: localStorage.getItem('concierge-name') || 'Guest',
        // Orders array stores each ordered menu item
        orders: JSON.parse(localStorage.getItem('concierge-orders') || '[]'),
        // Current room number for the guest
        room: localStorage.getItem('concierge-room') || '1205',
        // ISO strings representing check-in and check-out dates
        checkin:
          localStorage.getItem('concierge-checkin') || new Date().toISOString(),
        checkout:
          localStorage.getItem('concierge-checkout') ||
          new Date(Date.now() + 2 * 24 * 60 * 60 * 1000).toISOString(),
        // Network connectivity toggle. When true network dependent
        // features such as maps and weather will be displayed.
        network:
          localStorage.getItem('concierge-network') === 'true',
        // Profile holds dietary preferences, allergies and voice setting.
        profile:
          JSON.parse(localStorage.getItem('concierge-profile') ||
          JSON.stringify({ diet: 'all', allergies: '', voice: false })),
        // Geographic coordinates used for map and weather placeholders.
        geo:
          JSON.parse(localStorage.getItem('concierge-geo') ||
          JSON.stringify({ lat: 53.3498, lon: -6.2603 })),
        // Notification log for the tray. Each entry has message and timestamp.
        notifications:
          JSON.parse(localStorage.getItem('concierge-notifications') || '[]'),
        // Activity log stores actions (orders, services, etc.) with timestamps.
        activity:
          JSON.parse(localStorage.getItem('concierge-activity') || '[]'),
        // Selected language for the interface.
        lang: localStorage.getItem('concierge-lang') || 'en',

        // Room controls for in-room amenities like lights, AC temperature and drapes.
        controls:
          JSON.parse(localStorage.getItem('concierge-controls') ||
          JSON.stringify({ lights: true, ac: 22, drapes: true })),

        // Guest feedback entries (rating and comment)
        feedbacks:
          JSON.parse(localStorage.getItem('concierge-feedbacks') || '[]'),
        // Selected currency for prices (EUR, USD, GBP)
        currency: localStorage.getItem('concierge-currency') || 'EUR',

        // Wake-up call time (ISO time string or null). When set, the
        // application will schedule a notification at the specified
        // time. This property persists across sessions so that the
        // guest‚Äôs wake-up call is remembered.
        wakeTime: localStorage.getItem('concierge-wake') || '',
        // Personal reminders array. Each reminder has id, title,
        // due timestamp, and done flag. Reminders trigger notifications
        // when due and are persisted across visits.
        reminders:
          JSON.parse(localStorage.getItem('concierge-reminders') || '[]'),
        // Itinerary entries array. Each entry has id, title, timestamp and
        // location. Used to help guests plan their stay. Persisted
        // across visits.
        itinerary:
          JSON.parse(localStorage.getItem('concierge-itinerary') || '[]'),

        // Guest's home timezone identifier used to compute the home
        // country time. Defaults to UTC if not set. A list of common
        // timezones is provided in the profile form.
        homeTz: localStorage.getItem('concierge-homeTz') || 'UTC',

        // Accent colour selected by the guest. Used to customise the UI
        // accent hue. Defaults to the brand accent if not set.
        accentColor: localStorage.getItem('concierge-accent') || '#e3b505',
      };

      // Copy default state into a working state object
      const state = { ...defaultState };

      // Holds the Leaflet map instance when network features are enabled. This
      // allows us to reuse the map on subsequent renders rather than recreating
      // it each time. It is initialised lazily in renderMap().
      let leafletMapInstance = null;

      // Format a date string (ISO) into a user friendly format, e.g. "Aug 11, 2025".
      function fmtDate(dateStr) {
        const date = new Date(dateStr);
        return date.toLocaleDateString(undefined, {
          year: 'numeric',
          month: 'short',
          day: 'numeric',
        });
      }

      // Function to apply the current state to the DOM. It sets custom
      // attributes on the <body> element which activate the corresponding
      // CSS rules defined in the <style> section above. It also updates the
      // label on the theme toggle button to reflect the next state (so it
      // reads "Light" when currently dark, and vice versa).
      function applyState() {
        document.body.setAttribute('data-theme', state.theme);
        document.body.setAttribute('data-contrast', state.contrast);
        document.documentElement.setAttribute('data-text', state.text);
        // Update the theme toggle label to indicate the target state
        const themeLabel = state.theme === 'dark' ? 'Light' : 'Dark';
        document.getElementById('themeToggle').textContent = themeLabel;
        // Save state to localStorage
        localStorage.setItem('concierge-theme', state.theme);
        localStorage.setItem('concierge-contrast', state.contrast);
        localStorage.setItem('concierge-text', state.text);
        localStorage.setItem('concierge-name', state.name);
        // Persist additional state
        localStorage.setItem('concierge-orders', JSON.stringify(state.orders));
        localStorage.setItem('concierge-room', state.room);
        localStorage.setItem('concierge-checkin', state.checkin);
        localStorage.setItem('concierge-checkout', state.checkout);
        localStorage.setItem('concierge-notifications', JSON.stringify(state.notifications));
        localStorage.setItem('concierge-network', state.network);
        localStorage.setItem('concierge-profile', JSON.stringify(state.profile));
        localStorage.setItem('concierge-geo', JSON.stringify(state.geo));
        localStorage.setItem('concierge-activity', JSON.stringify(state.activity));
        localStorage.setItem('concierge-lang', state.lang);
        localStorage.setItem('concierge-controls', JSON.stringify(state.controls));
        localStorage.setItem('concierge-feedbacks', JSON.stringify(state.feedbacks));
        localStorage.setItem('concierge-currency', state.currency);
        // Persist new features
        localStorage.setItem('concierge-wake', state.wakeTime || '');
        localStorage.setItem('concierge-reminders', JSON.stringify(state.reminders));
        localStorage.setItem('concierge-itinerary', JSON.stringify(state.itinerary));
        localStorage.setItem('concierge-homeTz', state.homeTz);
        // Persist accent colour
        localStorage.setItem('concierge-accent', state.accentColor);
        // Update the welcome message
        document.getElementById('welcomeMessage').textContent =
          `Welcome, ${state.name}! Your preferences are stored locally.`;
        // Update stay information if the elements exist
        const roomEl = document.getElementById('roomNumber');
        if (roomEl) {
          roomEl.textContent = state.room;
        }
        const rangeEl = document.getElementById('stayDateRange');
        if (rangeEl) {
          rangeEl.textContent = `${fmtDate(state.checkin)} ‚Üí ${fmtDate(state.checkout)}`;
        }

        // Update profile form fields if present
        const nameInput = document.getElementById('profileName');
        if (nameInput) nameInput.value = state.name;
        const dietSelect = document.getElementById('profileDiet');
        if (dietSelect) dietSelect.value = state.profile.diet || 'all';
        const allergyInput = document.getElementById('profileAllergies');
        if (allergyInput) allergyInput.value = state.profile.allergies || '';
        const voiceCheckbox = document.getElementById('profileVoice');
        if (voiceCheckbox) voiceCheckbox.checked = !!state.profile.voice;
        const networkCheckbox = document.getElementById('profileNetwork');
        if (networkCheckbox) networkCheckbox.checked = !!state.network;

        // Update notification count badge
        const countEl = document.getElementById('notifCount');
        if (countEl) {
          countEl.textContent = String(state.notifications.length);
        }
        // Set the language attribute on the document
        document.documentElement.lang = state.lang;
        // Update the language select dropdown if present
        const langSelect = document.getElementById('langSelect');
        if (langSelect) {
          langSelect.value = state.lang;
        }
        // Update currency select
        const currencySelect = document.getElementById('currencySelect');
        if (currencySelect) {
          currencySelect.value = state.currency;
        }
        // Update home timezone selection
        const tzSelect = document.getElementById('profileTimeZone');
        if (tzSelect) {
          tzSelect.value = state.homeTz;
        }

        // Update accent colour input and apply CSS variable
        const accentInput = document.getElementById('profileAccent');
        if (accentInput) accentInput.value = state.accentColor || '#e3b505';
        // Apply the accent colour to the CSS custom property
        document.documentElement.style.setProperty('--accent', state.accentColor || '#e3b505');
        // Update wake-up status display
        const wakeStatus = document.getElementById('wakeStatus');
        if (wakeStatus) {
          if (state.wakeTime) {
            const t = new Date(state.wakeTime);
            const timeStr = t.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            const dateStr = t.toLocaleDateString();
            wakeStatus.textContent = `Wake-up call set for ${dateStr} at ${timeStr}`;
          } else {
            wakeStatus.textContent = 'No wake-up call set.';
          }
        }
        // Apply translations to headings
        translateUI();
      }

      // Apply state when the page first loads is handled at the end of
      // the script after all helper functions and translations are defined.

      // Event listeners for the accessibility toggle buttons
      document.getElementById('themeToggle').addEventListener('click', () => {
        state.theme = state.theme === 'dark' ? 'light' : 'dark';
        applyState();
        logActivity('Theme', `Changed to ${state.theme}`);
      });
      document.getElementById('contrastToggle').addEventListener('click', () => {
        state.contrast = state.contrast === 'high' ? 'normal' : 'high';
        applyState();
        logActivity('Contrast', `Changed to ${state.contrast}`);
      });
      document.getElementById('textToggle').addEventListener('click', () => {
        state.text = state.text === 'large' ? 'normal' : 'large';
        applyState();
        logActivity('Text size', `Changed to ${state.text}`);
      });

      // Language selection. When a new language is chosen, update state and
      // persist the choice. Display a toast indicating the change. For
      // demonstration, translation of content is minimal; however the
      // language code is stored and applied to the <html> element.
      const langSelectEl = document.getElementById('langSelect');
      if (langSelectEl) {
        langSelectEl.addEventListener('change', () => {
          const newLang = langSelectEl.value;
          state.lang = newLang;
          applyState();
          translateUI();
          logActivity('Language', `Changed to ${newLang}`);
          showToast(`Language set to ${langSelectEl.options[langSelectEl.selectedIndex].text}`);
        });
      }

      // Currency selection. Update currency and re-render price dependent
      // components when the guest selects a different currency.
      const currencySelectEl = document.getElementById('currencySelect');
      if (currencySelectEl) {
        currencySelectEl.addEventListener('change', () => {
          const newCurr = currencySelectEl.value;
          state.currency = newCurr;
          applyState();
          logActivity('Currency', `Changed to ${newCurr}`);
          // Re-render menus and summaries with new currency
          renderMenu();
          renderOrders();
          renderFolio();
          showToast(`Currency switched to ${newCurr}`);
          // Update KPIs immediately
          updateClocks();
        });
      }

    // Accent colour selection. Allows guests to personalise the UI accent.
    const accentInputEl = document.getElementById('profileAccent');
    if (accentInputEl) {
      accentInputEl.addEventListener('change', () => {
        const newColour = accentInputEl.value || '#e3b505';
        state.accentColor = newColour;
        // Apply to document root and persist
        document.documentElement.style.setProperty('--accent', newColour);
        applyState();
        logActivity('Accent colour', `Changed to ${newColour}`);
        showToast('Accent colour updated');
      });
    }

      //
      // Part 1: Chat Interface Logic
      //--------------------------------
      // The chat component is a simple proof-of-concept offline chatbot. It
      // responds to certain keywords with canned replies and echoes any
      // unrecognized input. Future parts will integrate an AI powered
      // engine or offline natural language processing to provide richer
      // functionality.

      // Grab elements once to avoid repeated lookups
      const fab = document.getElementById('chatFab');
      const chatContainer = document.getElementById('chatContainer');
      const chatClose = document.getElementById('chatClose');
      const chatLog = document.getElementById('chatLog');
      const chatInput = document.getElementById('chatInput');
      const chatSend = document.getElementById('chatSend');

      // Predefined responses for offline usage. We define separate
      // dictionaries for each agent persona. These can be expanded
      // extensively to make the assistant feel more intelligent. When a
      // keyword is not found the chatbot echoes the user‚Äôs input.
      // Expandable response dictionaries for each agent. We generate
      // hundreds of keyword aliases by grouping synonyms. Each category has
      // an array of keywords and a single response. This makes MORPHO
      // appear smarter offline. Dynamic functions handle weather, time and
      // other real-time information.
      const buildResponseMap = (categories, dynamic = {}) => {
        const map = {};
        categories.forEach(({ keywords, response }) => {
          keywords.forEach((kw) => {
            map[kw.toLowerCase()] = response;
          });
        });
        // Attach dynamic keyword handlers separately
        Object.entries(dynamic).forEach(([k, fn]) => {
          map[k] = fn;
        });
        return map;
      };
      // Define concierge categories
      const conciergeCategories = [
        { keywords: ['hello','hi','hey','greetings','good morning','good afternoon','good evening','hola','bonjour','salut','hallo','ciao','hey there','hi there','hiya'], response: 'Hello! I‚Äôm MORPHO, your concierge AI. How may I assist you today?' },
        { keywords: ['towels','fresh towels','need towels','new towels','extra towels','towel','towel service'], response: 'Certainly! Fresh towels will be delivered to your room shortly.' },
        { keywords: ['housekeeping','clean room','room cleaning','need cleaning','maid service','cleanup','clean service'], response: 'Housekeeping has been notified and will visit your room.' },
        { keywords: ['taxi','cab','ride','call cab','book taxi','need a ride','uber','lyft'], response: 'A taxi has been booked for you. It will arrive at the entrance in 10 minutes.' },
        { keywords: ['spa','massage','relaxation','spa appointment','spa booking','massage appointment','spa session','hot tub'], response: 'Our spa has openings this afternoon. Would you like me to book an appointment?' },
        { keywords: ['checkout','late checkout','late check out','extend stay','check out','extend my stay','stay extension','early check out'], response: 'Late checkout is available until 2‚ÄØPM. Shall I extend your stay?' },
        { keywords: ['wifi','wi-fi','internet','password','network','wireless'], response: 'Our complimentary Wi‚ÄëFi network is ‚ÄúHotelGuest‚Äù. The password is printed on your key card.' },
        { keywords: ['breakfast','morning meal','breakfast time','breakfast hours','breakfast menu'], response: 'Breakfast is served from 7:00‚ÄØAM to 10:00‚ÄØAM in the dining area.' },
        { keywords: ['gym','fitness','workout','exercise','fitness center','gym open','workout room'], response: 'The gym is open 24/7 on the third floor. Your room key grants access.' },
        { keywords: ['pool','swimming','swim','swimming pool','pool hours','pool time','roof pool'], response: 'Our rooftop pool is open from 8‚ÄØAM to 8‚ÄØPM. Towels are provided.' },
        { keywords: ['menu','dining','food menu','food','lunch menu','dinner menu','restaurant menu','room service menu','eat'], response: 'You can browse our dining menu in the Dining section. Let me know if you‚Äôd like a recommendation.' },
        { keywords: ['events','activities','things to do','things happening','local events','entertainment','what‚Äôs on','what to do'], response: 'You can explore local events in the Local Events card. There are many activities to enjoy!' },
        { keywords: ['controls','room controls','lights','temperature','air conditioning','thermostat','drapes','curtains','curtain'], response: 'Use the Room Controls card to adjust lights, drapes and AC. Let me know if you need assistance.' },
        { keywords: ['map','directions','location','nearby','where are we','gps','address'], response: 'Enable network features to view the map and local weather in the Map & Weather card.' },
        { keywords: ['feedback','review','complaints','rate','rating','comments','survey','comment'], response: 'We appreciate your feedback! Use the Feedback card to rate your stay and leave comments.' },
        { keywords: ['music','listen music','play music','songs','radio','playlist','jazz','band'], response: 'While I can‚Äôt play music, I can recommend our lounge for live jazz on certain nights.' },
        { keywords: ['parking','car park','parking lot','valet','car','parking space','park car'], response: 'Valet parking is available. Please leave your keys with the concierge at the front desk.' },
        { keywords: ['laundry','washing','wash clothes','dry cleaning','drycleaning','iron','pressing'], response: 'Laundry and dry-cleaning services are available. Please place your garments in the provided bag and dial housekeeping.' },
        { keywords: ['room service','service in room','order to room','food service','room delivery'], response: 'Room service is available 24/7. Please browse the dining menu and let us know your selection.' },
        { keywords: ['restaurant','dining area','eat','food place','restaurant hours','caf√©','cafe','bar'], response: 'Our main restaurant is open from 12‚ÄØPM to 10‚ÄØPM. The bar and caf√© are open until midnight.' },
        { keywords: ['fitness','fitness centre','exercise room','training'], response: 'The fitness centre is located on the third floor and is open 24/7.' },
        { keywords: ['bar','pub','drinks','cocktail','wine','beer','alcohol','happy hour'], response: 'Our bar on the ground floor offers cocktails, wine and craft beers. Happy hour is from 5‚ÄØPM to 7‚ÄØPM.' },
        { keywords: ['kids','children','kids club','kid activities','children activities','childcare','baby'], response: 'We have a kids‚Äô club available daily from 9‚ÄØAM to 6‚ÄØPM and babysitting services on request.' },
        { keywords: ['conference','meeting','business room','meeting room','conference room','event room','boardroom'], response: 'Our conference facilities are available upon reservation. Please let me know your preferred time and size.' },
        { keywords: ['valet','car service','park my car','valet service'], response: 'Valet service is available at the main entrance. Please hand your keys to the valet attendant.' },
        { keywords: ['shuttle','airport shuttle','bus','hotel shuttle','transport','transportation','airport bus'], response: 'An airport shuttle departs hourly from the front of the hotel. Reserve your seat at the front desk.' },
        { keywords: ['doctor','medical','hospital','clinic','emergency','health','first aid'], response: 'For medical assistance, please contact the front desk. We can arrange doctor visits or transport to the nearest clinic.' },
      ];
      const conciergeDynamic = {
        weather: () => {
          const infoEl = document.getElementById('weatherInfo');
          const weatherText = infoEl ? infoEl.textContent : 'clear skies';
          return `Currently it‚Äôs ${weatherText}. Check the Dashboard for more details.`;
        },
        time: () => {
          const now = new Date();
          return `The local time is ${now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}.`;
        },
        currency: 'You can switch currencies using the dropdown at the top right of the app.',
        reminder: 'To add a reminder, open the Reminders card and fill in the title and time.',
        itinerary: 'Use the Itinerary card to add your planned activities and keep track of them.',
      };
      const botResponsesConcierge = buildResponseMap(conciergeCategories, conciergeDynamic);
      // Define explorer categories
      const explorerCategories = [
        { keywords: ['hello','hi','hey','greetings'], response: 'Hi! I‚Äôm your local explorer guide. Looking for adventures?' },
        { keywords: ['attractions','sights','sightseeing','monuments','landmarks','places to visit'], response: 'The city offers wonderful sights such as the historic castle and riverside promenade.' },
        { keywords: ['tours','guided tours','tour','excursion','city tours'], response: 'Walking tours depart every morning at 10‚ÄØAM from the lobby.' },
        { keywords: ['food','restaurants','places to eat','local food','eat','cuisine'], response: 'Don‚Äôt miss trying the famous local seafood chowder at the Market Caf√©.' },
        { keywords: ['shopping','shops','souvenirs','boutiques','markets','buy gifts'], response: 'For shopping, head to the Main Street boutiques and crafts market.' },
        { keywords: ['museum','museums','art gallery','gallery','exhibitions'], response: 'The art museum is a 15‚Äëminute walk away and free on Wednesdays.' },
        { keywords: ['parks','park','gardens','nature','green space','outdoor'], response: 'The central park offers beautiful walks and a lake. It‚Äôs great for a picnic.' },
        { keywords: ['history','historic','heritage','old town','historical'], response: 'Visit the Old Town to learn about the city‚Äôs rich history.' },
        { keywords: ['culture','cultural','arts','performances','concerts'], response: 'The cultural centre hosts art exhibitions and performances daily.' },
        { keywords: ['beach','sea','lake','waterfront'], response: 'The nearest beach is a 30‚Äëminute drive. We can arrange transport if you like.' },
        { keywords: ['hiking','trekking','walk','trails','nature walk'], response: 'There are scenic hiking trails nearby. Ask the front desk for a trail map.' },
        { keywords: ['nightlife','bars','clubs','pubs','evening'], response: 'For nightlife, explore the downtown bars and live music venues.' },
        { keywords: ['transport','public transport','bus','train','metro','subway','tram'], response: 'Public transport includes buses and trains; the nearest stop is two blocks away.' },
        { keywords: ['events','festivals','what‚Äôs on','things happening','activities'], response: 'Check the Local Events card for concerts, markets and festivals happening during your stay.' },
      ];
      const explorerDynamic = {
        weather: () => {
          const infoEl = document.getElementById('weatherInfo');
          const weatherText = infoEl ? infoEl.textContent : 'pleasant';
          return `According to the latest data, it‚Äôs ${weatherText}. Perfect for exploring!`;
        },
        time: () => {
          const now = new Date();
          return `It‚Äôs currently ${now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}. Great time for an adventure!`;
        },
        currency: 'Tap the currency dropdown to see prices in your preferred currency.',
        reminder: 'Set reminders for tours or events via the Reminders card.',
        itinerary: 'Plan your day with the Itinerary card. It‚Äôs your personal travel planner.',
      };
      const botResponsesExplorer = buildResponseMap(explorerCategories, explorerDynamic);
      // Define support categories
      const supportCategories = [
        { keywords: ['hello','hi','hey','greetings'], response: 'Hello, this is support. How can I help resolve your issue?' },
        { keywords: ['bill','billing','charge','charges','payment'], response: 'I‚Äôd be happy to review your bill. Please provide your room number and the details.' },
        { keywords: ['problem','issue','trouble','fault','error'], response: 'I‚Äôm sorry to hear that. Could you describe the problem in more detail?' },
        { keywords: ['noise','loud','disturbance','noisy'], response: 'We‚Äôll investigate the noise complaint and ensure your comfort.' },
        { keywords: ['complaint','feedback','report'], response: 'Your feedback is important to us. I‚Äôve logged your complaint and management will follow up.' },
        { keywords: ['refund','refunds','money back'], response: 'I‚Äôm sorry for the inconvenience. Let me look into a possible refund for you.' },
        { keywords: ['wifi','wi-fi','internet','password'], response: 'Our complimentary Wi‚ÄëFi network is ‚ÄúHotelGuest‚Äù. The password is printed on your key card.' },
        { keywords: ['room','suite','accommodation'], response: 'For room issues, please describe the problem and we‚Äôll dispatch maintenance.' },
        { keywords: ['maintenance','fix','repair','broken','damage'], response: 'I‚Äôm arranging maintenance for your room. They will arrive shortly.' },
        { keywords: ['cleaning','housekeeping','dirty','mess'], response: 'Housekeeping can assist with additional cleaning needs. I‚Äôll notify them.' },
        { keywords: ['lost','missing','lost item','left behind'], response: 'I‚Äôm sorry to hear you misplaced something. Please provide details and we‚Äôll search for it.' },
        { keywords: ['emergency','medical','help','urgent'], response: 'If this is an emergency, please dial the emergency number posted in your room. We can also call for assistance.' },
        { keywords: ['safety','security','safe','danger'], response: 'Our security team is available 24/7. I will notify them immediately.' },
        { keywords: ['parking','valet','car','vehicle'], response: 'If you have a parking issue, our valet team can assist. Please let me know the details.' },
        { keywords: ['check-in','check in','arrival','arrive','registration'], response: 'Check‚Äëin begins at 3‚ÄØPM. Please visit the front desk upon arrival.' },
        { keywords: ['check-out','check out','leaving','depart','departure'], response: 'Check‚Äëout is at 11‚ÄØAM. We can arrange a late check‚Äëout if needed.' },
      ];
      const supportDynamic = {
        weather: () => {
          const infoEl = document.getElementById('weatherInfo');
          const weatherText = infoEl ? infoEl.textContent : 'unavailable';
          return `Our data shows it‚Äôs ${weatherText}. If you need more info, please let us know.`;
        },
        time: () => {
          const now = new Date();
          return `The current time is ${now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}.`;
        },
        currency: 'If there‚Äôs a billing issue with currency, please specify your currency from the dropdown.',
        reminder: 'To schedule reminders for issues or follow‚Äëup, use the Reminders card.',
        itinerary: 'For scheduling support calls or meetings, use the Itinerary planner.',
      };
      const botResponsesSupport = buildResponseMap(supportCategories, supportDynamic);
      // Active agent state
      let activeAgent = 'concierge';

      // Translation dictionaries for supported languages. Only key user
      // interface labels and headings are translated. Additional terms
      // remain in English for simplicity. Feel free to expand these
      // dictionaries to support more languages or labels.
      const translations = {
        en: {
          welcome: 'Welcome',
          featuresOverview: 'Features Overview',
          dining: 'Dining',
          housekeeping: 'Housekeeping',
          stayInfo: 'Stay Information',
          profile: 'Profile',
          yourOrders: 'Your Orders',
          mapWeather: 'Map & Weather',
          services: 'Services',
          folio: 'Folio',
          activityLog: 'Activity Log',
          roomControls: 'Room Controls',
          feedback: 'Feedback',
          localEvents: 'Local Events',

          wake: 'Wake-up Call',
          reminders: 'Reminders',
          itinerary: 'Itinerary',

          dashboard: 'Dashboard',
          localTime: 'Local Time',
          homeTime: 'Home Time',
          daysLeft: 'Days Left',
          totalSpend: 'Total Spend',
          dailyTip: 'Daily Tip',
        accentColor: 'Accent colour',
        remindersCount: 'Reminders',
        itineraryCount: 'Itinerary',
        news: 'News',
        shuttle: 'Shuttle Schedule',
        },
        es: {
          welcome: 'Bienvenido',
          featuresOverview: 'Resumen de funciones',
          dining: 'Restaurante',
          housekeeping: 'Limpieza',
          stayInfo: 'Informaci√≥n de la estancia',
          profile: 'Perfil',
          yourOrders: 'Sus pedidos',
          mapWeather: 'Mapa y Tiempo',
          services: 'Servicios',
          folio: 'Cuenta',
          activityLog: 'Registro de actividad',
          roomControls: 'Controles de habitaci√≥n',
          feedback: 'Comentarios',
          localEvents: 'Eventos locales',

          wake: 'Despertador',
          reminders: 'Recordatorios',
          itinerary: 'Itinerario',

          dashboard: 'Tablero',
          localTime: 'Hora local',
          homeTime: 'Hora de origen',
          daysLeft: 'D√≠as restantes',
          totalSpend: 'Gasto total',
          dailyTip: 'Consejo del d√≠a',
        accentColor: 'Color de acento',
        remindersCount: 'Recordatorios',
        itineraryCount: 'Itinerario',
        news: 'Noticias',
        shuttle: 'Horario de transporte',
        },
      };

      // Currency conversion rates relative to EUR. These are simple
      // placeholders and can be updated dynamically via an API in a
      // connected environment. Symbols are mapped separately.
      const currencyRates = {
        EUR: 1,
        USD: 1.1,
        GBP: 0.85,
      };
      const currencySymbols = {
        EUR: '‚Ç¨',
        USD: '$',
        GBP: '¬£',
      };

      // Apply translations to heading elements based on the current language.
      function translateUI() {
        const lang = state.lang || 'en';
        const tr = translations[lang] || translations.en;
        const mapping = {
          welcomeHeading: tr.welcome,
          featuresHeading: tr.featuresOverview,
          diningHeading: tr.dining,
          housekeepingHeading: tr.housekeeping,
          stayHeading: tr.stayInfo,
          profileHeading: tr.profile,
          ordersHeading: tr.yourOrders,
          mapHeading: tr.mapWeather,
          servicesHeading: tr.services,
          folioHeading: tr.folio,
          activityHeading: tr.activityLog,
          roomControlsHeading: tr.roomControls,
          feedbackHeading: tr.feedback,
          eventsHeading: tr.localEvents,
          wakeHeading: tr.wake,
          reminderHeading: tr.reminders,
          itineraryHeading: tr.itinerary,
          dashboardHeading: tr.dashboard,
          localTimeLabel: tr.localTime,
          homeTimeLabel: tr.homeTime,
          daysLeftLabel: tr.daysLeft,
          totalSpendLabel: tr.totalSpend,
          dailyTipLabel: tr.dailyTip,
          accentColorLabel: tr.accentColor,
          remindersLabel: tr.remindersCount,
          itineraryLabel: tr.itineraryCount,
          newsHeading: tr.news,
          shuttleHeading: tr.shuttle,
        };
        Object.entries(mapping).forEach(([id, text]) => {
          const el = document.getElementById(id);
          if (el) el.textContent = text;
        });
      }

      // Helper to append a message bubble to the chat log
      function appendMessage(content, sender = 'bot') {
        const msg = document.createElement('div');
        msg.className = `chat-bubble ${sender}`;
        msg.textContent = content;
        chatLog.appendChild(msg);
        chatLog.scrollTop = chatLog.scrollHeight;

        // If voice assistant is enabled and the sender is the bot,
        // speak the message aloud using the Web Speech API. This uses
        // the browser‚Äôs default voice. Speech synthesis is supported
        // in modern browsers and works offline in most cases. We wrap
        // the call in a try/catch to avoid errors if the API is
        // unavailable.
        if (sender === 'bot' && state.profile && state.profile.voice) {
          try {
            const utter = new SpeechSynthesisUtterance(content);
            utter.lang = state.lang;
            window.speechSynthesis.speak(utter);
          } catch (err) {
            console.warn('Speech synthesis error', err);
          }
        }
      }

      // Toggle chat visibility when the floating action button is clicked
      fab.addEventListener('click', () => {
        chatContainer.style.display = chatContainer.style.display === 'flex' ? 'none' : 'flex';
        chatContainer.style.flexDirection = 'column';
        if (chatContainer.style.display === 'flex') {
          // Auto focus the input when opening chat
          setTimeout(() => chatInput.focus(), 50);
          // If chat log is empty, greet the user according to the active agent
          if (chatLog && chatLog.children.length === 0) {
            const greetings = {
              concierge: 'Hello! I‚Äôm your concierge. How may I assist you?',
              explorer: 'Hi! I‚Äôm your explorer guide. Ready for an adventure?',
              support: 'Hello, support here. How can I help?'
            };
            appendMessage(greetings[activeAgent] || 'Hello!', 'bot');
          }
        }
      });
      // Close chat when the close button is clicked
      chatClose.addEventListener('click', () => {
        chatContainer.style.display = 'none';
      });
      // Send message when the user clicks send or presses Enter
      function sendMessage() {
        const text = chatInput.value.trim();
        if (!text) return;
        appendMessage(text, 'user');
        chatInput.value = '';
        // Determine response based on simple keyword matching
        // Choose responses based on the active agent
        let responses;
        if (activeAgent === 'concierge') responses = botResponsesConcierge;
        else if (activeAgent === 'explorer') responses = botResponsesExplorer;
        else responses = botResponsesSupport;
        const key = Object.keys(responses).find((k) => text.toLowerCase().includes(k));
        let response = key ? responses[key] : undefined;
        // If the response is a function, call it to get dynamic text
        if (typeof response === 'function') {
          try {
            response = response();
          } catch (err) {
            response = undefined;
          }
        }
        const reply = response || `You said: ${text}`;
        // Simulate a short delay to mimic thinking
        setTimeout(() => appendMessage(reply, 'bot'), 400);
      }
      chatSend.addEventListener('click', sendMessage);
      chatInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          sendMessage();
        }
      });

      //
      // Part 2: Feature Implementations
      //--------------------------------
      // Toast helper for user feedback. Creates a temporary notification
      // element inside the toast container and removes it after four
      // seconds. Uses CSS animations to fade out gracefully.
      function showToast(message) {
        const container = document.getElementById('toastContainer');
        if (!container) return;
        const toast = document.createElement('div');
        toast.className = 'toast';
        toast.textContent = message;
        container.appendChild(toast);
        // Record the notification in state and persist it
        state.notifications.unshift({ message, ts: Date.now() });
        localStorage.setItem('concierge-notifications', JSON.stringify(state.notifications));
        // Also log the toast in the activity log for audit
        logActivity('Notification', message);
        // Update the notification tray and badge
        renderNotifications();
        applyState();
        setTimeout(() => {
          toast.remove();
        }, 4000);
      }

      // Dining menu items available for ordering. Each item has an
      // identifier, a name, a short description and a price.
      const menuItems = [
        { id: 'm1', name: 'Margherita Pizza', desc: 'San Marzano, basil, fior di latte', price: 16 },
        { id: 'm2', name: 'Caesar Salad', desc: 'Parmesan, croutons', price: 12 },
        { id: 'm3', name: 'Vegan Buddha Bowl', desc: 'Quinoa, chickpeas, veggies', price: 15 },
        { id: 'm4', name: 'Grilled Salmon', desc: 'Lemon butter sauce, asparagus', price: 22 },
        { id: 'm5', name: 'Ribeye Steak', desc: 'Herb butter, crispy potatoes', price: 28 },
        { id: 'm6', name: 'Pancakes Stack', desc: 'Maple syrup, berries', price: 10 },
      ];

      // News headlines for the News card. These can be dynamically
      // updated in a connected environment. Each item has a title and
      // description. Feel free to extend this list for more headlines.
      const newsItems = [
        { title: 'Hotel Wins Sustainability Award', desc: 'Our property has been recognised for its exceptional green initiatives.' },
        { title: 'New Rooftop Bar Opening', desc: 'Join us this Friday for the grand opening of our rooftop cocktail lounge.' },
        { title: 'Chef‚Äôs Special Menu Launched', desc: 'Our executive chef introduces a seasonal tasting menu this week.' },
      ];

      // Shuttle departure times. Each entry includes a time and a
      // destination. These are placeholders and can be updated via an API.
      const shuttleTimes = [
        { time: '08:00', destination: 'Airport' },
        { time: '09:30', destination: 'Convention Centre' },
        { time: '11:00', destination: 'Downtown' },
        { time: '13:00', destination: 'Airport' },
        { time: '15:30', destination: 'Shopping District' },
      ];

      // Render menu items into the DOM. Creates list items with name,
      // description, price and an order button. The button carries a
      // data-menu-id attribute to identify the item.
      function renderMenu() {
        const list = document.getElementById('menuList');
        if (!list) return;
        list.innerHTML = '';
        // Obtain current search query, if any. Filter items based on query.
        const searchInput = document.getElementById('menuSearch');
        const query = searchInput ? searchInput.value.trim().toLowerCase() : '';
        menuItems
          .filter((item) => item.name.toLowerCase().includes(query))
          .forEach((item) => {
            const li = document.createElement('li');
            li.className = 'menu-item';
            const rate = currencyRates[state.currency] || 1;
            const symbol = currencySymbols[state.currency] || '';
            const priceConverted = (item.price * rate).toFixed(2);
            // Each menu item includes a quantity selector so guests can customise
            // how many portions they‚Äôd like. The number input is small and
            // defaults to 1. The order button will multiply the quantity
            // accordingly when clicked.
            li.innerHTML = `
            <div class="info">
              <span class="name">${item.name}</span>
              <span class="desc">${item.desc}</span>
            </div>
            <input type="number" class="quantity" min="1" value="1" style="width:3rem; padding:0.2rem 0.3rem; border:1px solid var(--border); border-radius:var(--radius-sm); background:var(--card-alt); color:var(--fg); margin-right:0.4rem;" />
            <span class="price">${symbol}${priceConverted}</span>
            <button class="btn-primary" data-menu-id="${item.id}">Order</button>
          `;
            list.appendChild(li);
          });
      }

      // Event handler for ordering items via event delegation. When a
      // button with data-menu-id is clicked, we find the item, push it
      // into the orders array on state, persist it and show a toast.
      const menuListEl = document.getElementById('menuList');
      if (menuListEl) {
        menuListEl.addEventListener('click', (e) => {
          const btn = e.target.closest('button[data-menu-id]');
          if (!btn) return;
          const id = btn.getAttribute('data-menu-id');
          const item = menuItems.find((x) => x.id === id);
          if (!item) return;
          // Determine quantity from the associated number input
          const li = btn.closest('.menu-item');
          const qtyInput = li ? li.querySelector('input.quantity') : null;
          const qty = qtyInput ? parseInt(qtyInput.value) || 1 : 1;
          let estTime;
          for (let i = 0; i < qty; i++) {
            // Estimate delivery time based on the queue length (20 min + 5 min per item)
            estTime = 20 + 5 * state.orders.length;
            state.orders.push({ ...item, estTime });
          }
          localStorage.setItem('concierge-orders', JSON.stringify(state.orders));
          // Toast indicates quantity and approximate delivery time
          showToast(`${item.name} √ó${qty} added to your order. Est. ${estTime}‚ÄØmin`);
          // Refresh order and folio summaries after adding an item
          renderOrders();
          renderFolio();
        });
      }

      // Menu search handler. On input, refresh the displayed menu items.
      const menuSearchEl = document.getElementById('menuSearch');
      if (menuSearchEl) {
        menuSearchEl.addEventListener('input', () => {
          renderMenu();
        });
      }

      // Housekeeping actions. Delegates click events on the housekeeping
      // card to handle various housekeeping requests.
      const housekeepingEl = document.getElementById('housekeepingCard');
      if (housekeepingEl) {
        housekeepingEl.addEventListener('click', (e) => {
          const btn = e.target.closest('button[data-action]');
          if (!btn) return;
          const act = btn.dataset.action;
          if (act === 'clean') {
            showToast('Housekeeping requested. We will clean your room shortly.');
          } else if (act === 'towels') {
            // Ask the guest how many towels they need using a simple prompt.
            const qtyInput = prompt('How many fresh towels would you like?', '2');
            const qty = parseInt(qtyInput) || 1;
            showToast(`Fresh towels (${qty}) are on their way.`);
            logActivity('Housekeeping', `${qty} towels requested`);
          } else if (act === 'wake') {
            // Allow guests to choose their wake-up time for quick access. If
            // they leave it blank, fall back to default 6:30 AM.
            const t = prompt('What time would you like your wake-up call?', '06:30');
            const timeStr = t && t.trim() ? t.trim() : '06:30';
            showToast(`Wake-up call has been scheduled for ${timeStr}.`);
            logActivity('Wake-up', `Call set for ${timeStr}`);
          }
        });
      }

      // Door unlock and stay extension buttons
      const unlockBtn = document.getElementById('unlockBtn');
      if (unlockBtn) {
        unlockBtn.addEventListener('click', () => {
          showToast('Door unlocked. Welcome!');
        });
      }
      const extendBtn = document.getElementById('extendBtn');
      if (extendBtn) {
        extendBtn.addEventListener('click', () => {
          const newCheckout = new Date(state.checkout);
          newCheckout.setDate(newCheckout.getDate() + 1);
          state.checkout = newCheckout.toISOString();
          applyState();
          showToast('Your stay has been extended by one day.');
        });
      }

      // Initial rendering of dynamic components
      // Render menus, orders and map on page load
      function renderOrders() {
        const list = document.getElementById('orderSummaryList');
        const totalEl = document.getElementById('orderTotal');
        if (!list || !totalEl) return;
        list.innerHTML = '';
        let total = 0;
        const rate = currencyRates[state.currency] || 1;
        const symbol = currencySymbols[state.currency] || '';
        state.orders.forEach((item) => {
          total += item.price * rate;
          const li = document.createElement('li');
          li.className = 'summary-item';
          const converted = (item.price * rate).toFixed(2);
          li.innerHTML = `<span>${item.name}</span><span>${symbol}${converted}</span>`;
          list.appendChild(li);
        });
        totalEl.textContent = state.orders.length > 0 ? `Total: ${symbol}${total.toFixed(2)}` : '';
        // Display estimated delivery time based on the slowest order
        const estimateEl = document.getElementById('orderEstimate');
        if (estimateEl) {
          if (state.orders.length > 0) {
            const maxEst = Math.max(...state.orders.map((it) => it.estTime || 0));
            estimateEl.textContent = `Estimated delivery: ~${maxEst} min`;
          } else {
            estimateEl.textContent = '';
          }
        }
        // Update dashboard totals when orders change
        updateClocks();
      }

      function renderMap() {
        const canvas = document.getElementById('mapCanvas');
        const overlay = document.getElementById('mapOverlay');
        const weatherInfo = document.getElementById('weatherInfo');
        if (!canvas || !overlay || !weatherInfo) return;
        const ctx = canvas.getContext('2d');
        // Helper to draw a simple grid map with a marker
        function drawOfflineMap(lat = 0, lon = 0) {
          // Clear canvas
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          // Fill background
          ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--card-alt');
          ctx.fillRect(0, 0, canvas.width, canvas.height);
          // Draw grid lines
          ctx.strokeStyle = getComputedStyle(document.body).getPropertyValue('--border-alt');
          ctx.lineWidth = 1;
          const rows = 6;
          const cols = 10;
          for (let i = 1; i < rows; i++) {
            const y = (canvas.height / rows) * i;
            ctx.beginPath();
            ctx.moveTo(0, y);
            ctx.lineTo(canvas.width, y);
            ctx.stroke();
          }
          for (let i = 1; i < cols; i++) {
            const x = (canvas.width / cols) * i;
            ctx.beginPath();
            ctx.moveTo(x, 0);
            ctx.lineTo(x, canvas.height);
            ctx.stroke();
          }
          // Draw marker at center
          const markerX = canvas.width / 2;
          const markerY = canvas.height / 2;
          ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--brand-primary');
          ctx.beginPath();
          ctx.arc(markerX, markerY, 6, 0, Math.PI * 2);
          ctx.fill();
          // Draw text for coordinates
          ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--fg-muted');
          ctx.font = '12px ' + getComputedStyle(document.body).getPropertyValue('font-family');
          const coordText = `Lat ${lat.toFixed(2)}, Lon ${lon.toFixed(2)}`;
          ctx.fillText(coordText, 6, canvas.height - 8);
        }

        // Draws a decorative gradient map reminiscent of earlier prototypes
        function drawGradientMap(lat = 0, lon = 0) {
          // Clear canvas
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          // Create radial gradient using brand colours
          const bp = getComputedStyle(document.body).getPropertyValue('--brand-primary').trim() || '#0ea5e9';
          const bs = getComputedStyle(document.body).getPropertyValue('--brand-secondary').trim() || '#22d3ee';
          const gradient = ctx.createRadialGradient(
            canvas.width / 2,
            canvas.height / 2,
            0,
            canvas.width / 2,
            canvas.height / 2,
            Math.max(canvas.width, canvas.height) / 1.2
          );
          gradient.addColorStop(0, bp);
          gradient.addColorStop(1, bs);
          ctx.fillStyle = gradient;
          ctx.fillRect(0, 0, canvas.width, canvas.height);
          // Dark overlay with rounded corners
          ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--card');
          ctx.beginPath();
          const radius = 12;
          const w = canvas.width - 4;
          const h = canvas.height - 4;
          const x = 2;
          const y = 2;
          ctx.moveTo(x + radius, y);
          ctx.lineTo(x + w - radius, y);
          ctx.quadraticCurveTo(x + w, y, x + w, y + radius);
          ctx.lineTo(x + w, y + h - radius);
          ctx.quadraticCurveTo(x + w, y + h, x + w - radius, y + h);
          ctx.lineTo(x + radius, y + h);
          ctx.quadraticCurveTo(x, y + h, x, y + h - radius);
          ctx.lineTo(x, y + radius);
          ctx.quadraticCurveTo(x, y, x + radius, y);
          ctx.closePath();
          ctx.fill();
          // Central marker box
          const markerW = 100;
          const markerH = 26;
          const markerX = (canvas.width - markerW) / 2;
          const markerY = (canvas.height - markerH) / 2;
          ctx.fillStyle = bp;
          ctx.fillRect(markerX, markerY, markerW, markerH);
          // Text inside marker
          ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--bg');
          ctx.font = 'bold 14px ' + getComputedStyle(document.body).getPropertyValue('font-family');
          ctx.textAlign = 'center';
          ctx.textBaseline = 'middle';
          ctx.fillText('You are here', markerX + markerW / 2, markerY + markerH / 2);
          // Coordinates text bottom left
          ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--fg-muted');
          ctx.font = '12px ' + getComputedStyle(document.body).getPropertyValue('font-family');
          ctx.textAlign = 'left';
          ctx.fillText(`Lat ${lat.toFixed(4)}, Lon ${lon.toFixed(4)}`, 6, canvas.height - 8);
        }
        // Determine offline or online state
        if (!state.network) {
          // Show the offline map (grid) and hide the Leaflet container
          canvas.style.display = 'block';
          const mapDiv = document.getElementById('leafletMap');
          if (mapDiv) mapDiv.style.display = 'none';
          drawOfflineMap(state.geo.lat, state.geo.lon);
          overlay.textContent = 'Enable network to load the live map.';
          weatherInfo.textContent = 'N/A';
        } else {
          // Hide the offline canvas and display the interactive Leaflet map
          canvas.style.display = 'none';
          const mapDiv = document.getElementById('leafletMap');
          if (mapDiv) mapDiv.style.display = 'block';
          // Initialise or update Leaflet map instance
          if (typeof L !== 'undefined') {
            if (!leafletMapInstance) {
              leafletMapInstance = L.map('leafletMap', {
                attributionControl: false,
                zoomControl: false,
              }).setView([state.geo.lat, state.geo.lon], 14);
              L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '&copy; OpenStreetMap contributors',
              }).addTo(leafletMapInstance);
              // Add marker to indicate current location
              L.marker([state.geo.lat, state.geo.lon]).addTo(leafletMapInstance).bindPopup('You are here').openPopup();
            } else {
              leafletMapInstance.setView([state.geo.lat, state.geo.lon], 14);
            }
          }
          overlay.textContent = '';
          // Fetch current weather from Open‚ÄëMeteo API; fallback on error
          (async () => {
            try {
              const url = `https://api.open-meteo.com/v1/forecast?latitude=${state.geo.lat}&longitude=${state.geo.lon}&current_weather=true`;
              const res = await fetch(url);
              if (!res.ok) throw new Error('Weather fetch failed');
              const data = await res.json();
              if (data && data.current_weather) {
                const temp = data.current_weather.temperature;
                const codes = {
                  0: 'Clear',
                  1: 'Mainly clear',
                  2: 'Partly cloudy',
                  3: 'Overcast',
                  45: 'Fog',
                  48: 'Depositing rime fog',
                  51: 'Light drizzle',
                  53: 'Moderate drizzle',
                  55: 'Dense drizzle',
                  61: 'Light rain',
                  63: 'Moderate rain',
                  65: 'Heavy rain',
                  71: 'Light snow',
                  73: 'Moderate snow',
                  75: 'Heavy snow',
                  95: 'Thunderstorm',
                };
                const description = codes[data.current_weather.weathercode] || '';
                weatherInfo.textContent = `${description} ${temp}¬∞C`;
              } else {
                weatherInfo.textContent = 'Weather unavailable';
              }
            } catch (err) {
              // Fallback weather if API fails
              const cond = ['Sunny','Cloudy','Partly cloudy','Rain'];
              const temp = 16 + Math.round(Math.random() * 8);
              weatherInfo.textContent = `${cond[Math.floor(Math.random() * cond.length)]} ${temp}¬∞C`;
            }
          })();
        }
      }

      // Profile save handler updates state values and persists them
      const profileSaveBtn = document.getElementById('profileSave');
      if (profileSaveBtn) {
        profileSaveBtn.addEventListener('click', () => {
          // Update name, diet and allergies from the form fields
          const newName = document.getElementById('profileName').value.trim() || 'Guest';
          state.name = newName;
          state.profile.diet = document.getElementById('profileDiet').value;
          state.profile.allergies = document.getElementById('profileAllergies').value;
          state.profile.voice = document.getElementById('profileVoice').checked;
          // Update network from checkbox
          state.network = document.getElementById('profileNetwork').checked;
          // Update home timezone
          const tzSelectEl = document.getElementById('profileTimeZone');
          if (tzSelectEl) {
            state.homeTz = tzSelectEl.value;
          }
          applyState();
          renderMap();
          showToast('Profile saved');
          // Immediately update clocks when timezone changes
          updateClocks();
          // Refresh currency rates if network was enabled
          fetchCurrencyRates();
        });
      }

      // Clear orders button resets the orders array and updates the summary
      const clearOrdersBtn = document.getElementById('clearOrdersBtn');
      if (clearOrdersBtn) {
        clearOrdersBtn.addEventListener('click', () => {
          state.orders = [];
          localStorage.setItem('concierge-orders', JSON.stringify(state.orders));
          renderOrders();
          renderFolio();
          updateClocks();
          showToast('Your order list has been cleared.');
        });
      }

      // Render notifications into the tray and update the count badge
      function renderNotifications() {
        const listEl = document.getElementById('notifList');
        if (!listEl) return;
        listEl.innerHTML = '';
        state.notifications.forEach((notif) => {
          const div = document.createElement('div');
          div.className = 'notif-item';
          const timeStr = new Date(notif.ts).toLocaleTimeString([], {
            hour: '2-digit',
            minute: '2-digit',
          });
          div.innerHTML = `<div>${notif.message}</div><div class="time">${timeStr}</div>`;
          listEl.appendChild(div);
        });
        // Update badge count
        const countEl = document.getElementById('notifCount');
        if (countEl) {
          countEl.textContent = String(state.notifications.length);
        }
      }

      // Render the folio card showing all current orders
      function renderFolio() {
        const list = document.getElementById('folioList');
        const totalEl = document.getElementById('folioTotal');
        if (!list || !totalEl) return;
        list.innerHTML = '';
        let total = 0;
        const rate = currencyRates[state.currency] || 1;
        const symbol = currencySymbols[state.currency] || '';
        state.orders.forEach((item) => {
          total += item.price * rate;
          const li = document.createElement('li');
          li.className = 'summary-item';
          const converted = (item.price * rate).toFixed(2);
          li.innerHTML = `<span>${item.name}</span><span>${symbol}${converted}</span>`;
          list.appendChild(li);
        });
        if (state.orders.length > 0) {
          totalEl.textContent = `Total: ${symbol}${total.toFixed(2)}`;
        } else {
          totalEl.textContent = 'No charges.';
        }
        // Update dashboard totals when folio changes
        updateClocks();
      }

      // Log an activity event. Each activity entry consists of an action label,
      // optional details and a timestamp. Entries are prepended so the
      // newest appears at the top. After updating the log, we persist it
      // and re-render the activity list.
      function logActivity(action, details = '') {
        state.activity.unshift({ action, details, ts: Date.now() });
        localStorage.setItem('concierge-activity', JSON.stringify(state.activity));
        renderActivity();
      }

      // Render the activity log into its list. Shows up to 50 recent entries.
      function renderActivity() {
        const list = document.getElementById('activityList');
        if (!list) return;
        list.innerHTML = '';
        // Limit to the most recent 50 entries to avoid huge lists
        const maxEntries = 50;
        state.activity.slice(0, maxEntries).forEach((entry) => {
          const li = document.createElement('li');
          const timeStr = new Date(entry.ts).toLocaleTimeString([], {
            hour: '2-digit',
            minute: '2-digit',
          });
          li.innerHTML = `<span>${entry.action}${entry.details ? ': ' + entry.details : ''}</span><span class="time">${timeStr}</span>`;
          list.appendChild(li);
        });
      }

      // Render room controls UI based on current state values
      function renderRoomControls() {
        const lightsToggle = document.getElementById('lightsToggle');
        const drapesToggle = document.getElementById('drapesToggle');
        const acSlider = document.getElementById('acSlider');
        const acLabel = document.getElementById('acTempLabel');
        if (lightsToggle) lightsToggle.checked = !!state.controls.lights;
        if (drapesToggle) drapesToggle.checked = !!state.controls.drapes;
        if (acSlider) acSlider.value = state.controls.ac;
        if (acLabel) acLabel.textContent = state.controls.ac;
      }

      // Render local events list. These are static for demonstration
      // purposes but could be loaded from a server when network is enabled.
      const events = [
        { id: 'e1', title: 'Live Jazz at the Lounge', date: 'Tonight 8 PM', desc: 'Experience smooth jazz with local musicians.' },
        { id: 'e2', title: 'City Walking Tour', date: 'Tomorrow 10 AM', desc: 'Guided tour through historic landmarks.' },
        { id: 'e3', title: 'Wine Tasting', date: 'Fri 6 PM', desc: 'Sample local wines paired with appetizers.' },
      ];
      function renderEvents() {
        const list = document.getElementById('eventsList');
        if (!list) return;
        list.innerHTML = '';
        events.forEach((ev) => {
          const li = document.createElement('li');
          li.innerHTML = `
            <span class="event-title">${ev.title}</span>
            <span class="event-date">${ev.date}</span>
            <span class="event-desc" style="font-size:0.85rem; color:var(--fg-muted);">${ev.desc}</span>
            <button class="btn-primary" data-event-id="${ev.id}">Book</button>
          `;
          list.appendChild(li);
        });
      }

      // Render news headlines into the News card. Each item displays a
      // bold title and a muted description. In a connected environment
      // these could be fetched from an API.
      function renderNews() {
        const list = document.getElementById('newsList');
        if (!list) return;
        list.innerHTML = '';
        newsItems.forEach((item) => {
          const li = document.createElement('li');
          li.style.padding = '0.4rem 0';
          li.innerHTML = `<strong>${item.title}</strong><br /><span style="font-size:0.85rem; color:var(--fg-muted);">${item.desc}</span>`;
          list.appendChild(li);
        });
      }

      // Render shuttle schedule into the Shuttle card. Displays the
      // departure time and destination in a simple list.
      function renderShuttle() {
        const list = document.getElementById('shuttleList');
        if (!list) return;
        list.innerHTML = '';
        shuttleTimes.forEach((item) => {
          const li = document.createElement('li');
          li.style.padding = '0.4rem 0';
          li.innerHTML = `<span style="font-weight:600;">${item.time}</span> ‚Äì <span style="font-size:0.9rem;">${item.destination}</span>`;
          list.appendChild(li);
        });
      }

      // Toggle notification tray visibility
      const notifBell = document.getElementById('notifBell');
      const notifTray = document.getElementById('notifTray');
      if (notifBell && notifTray) {
        notifBell.addEventListener('click', () => {
          notifTray.style.display = notifTray.style.display === 'flex' ? 'none' : 'flex';
        });
      }
      // Clear notifications
      const clearNotifBtn = document.getElementById('clearNotifBtn');
      if (clearNotifBtn) {
        clearNotifBtn.addEventListener('click', () => {
          state.notifications = [];
          localStorage.setItem('concierge-notifications', JSON.stringify(state.notifications));
          renderNotifications();
          applyState();
          showToast('Notifications cleared');
        });
      }

      // Clear activity log
      const clearActivityBtn = document.getElementById('clearActivityBtn');
      if (clearActivityBtn) {
        clearActivityBtn.addEventListener('click', () => {
          state.activity = [];
          localStorage.setItem('concierge-activity', JSON.stringify(state.activity));
          renderActivity();
          applyState();
          showToast('Activity log cleared');
          logActivity('Activity', 'Log cleared');
        });
      }

      // Service actions
      const servicesEl = document.getElementById('servicesCard');
      if (servicesEl) {
        servicesEl.addEventListener('click', (e) => {
          const btn = e.target.closest('button[data-service]');
          if (!btn) return;
          const svc = btn.dataset.service;
          if (svc === 'spa') {
            showToast('Spa appointment booked. Our concierge will contact you.');
          } else if (svc === 'taxi') {
            showToast('Taxi requested. It will arrive at the entrance shortly.');
          } else if (svc === 'late-checkout') {
            showToast('Late checkout request received. We will confirm availability.');
          } else if (svc === 'wake-up') {
            showToast('Custom wake-up call scheduled.');
          }
        });
      }

      // Pay now event
      const payNowBtn = document.getElementById('payNowBtn');
      if (payNowBtn) {
        payNowBtn.addEventListener('click', () => {
          if (state.orders.length === 0) {
            showToast('Your folio is empty.');
            return;
          }
          showToast('Payment processed. Thank you for your stay!');
          state.orders = [];
          localStorage.setItem('concierge-orders', JSON.stringify(state.orders));
          renderOrders();
          renderFolio();
          updateClocks();
        });
      }

      // Room controls interactions
      const lightsEl = document.getElementById('lightsToggle');
      if (lightsEl) {
        lightsEl.addEventListener('change', () => {
          state.controls.lights = lightsEl.checked;
          applyState();
          renderRoomControls();
          const status = lightsEl.checked ? 'on' : 'off';
          logActivity('Lights', status);
          showToast(`Lights turned ${status}`);
        });
      }
      const drapesEl = document.getElementById('drapesToggle');
      if (drapesEl) {
        drapesEl.addEventListener('change', () => {
          state.controls.drapes = drapesEl.checked;
          applyState();
          renderRoomControls();
          const status = drapesEl.checked ? 'open' : 'closed';
          logActivity('Drapes', status);
          showToast(`Drapes ${status}`);
        });
      }
      const acSliderEl = document.getElementById('acSlider');
      const acLabelEl = document.getElementById('acTempLabel');
      if (acSliderEl) {
        acSliderEl.addEventListener('input', () => {
          const val = parseInt(acSliderEl.value, 10);
          state.controls.ac = val;
          if (acLabelEl) acLabelEl.textContent = val;
        });
        acSliderEl.addEventListener('change', () => {
          const val = parseInt(acSliderEl.value, 10);
          state.controls.ac = val;
          applyState();
          renderRoomControls();
          logActivity('AC temperature', `${val}¬∞C`);
          showToast(`AC set to ${val}¬∞C`);
        });
      }

      // Feedback submission
      const feedbackSubmit = document.getElementById('feedbackSubmit');
      if (feedbackSubmit) {
        feedbackSubmit.addEventListener('click', () => {
          const ratingSel = document.getElementById('feedbackRating');
          const commentEl = document.getElementById('feedbackComment');
          const rating = ratingSel ? parseInt(ratingSel.value, 10) : null;
          const comment = commentEl ? commentEl.value.trim() : '';
          if (!rating) {
            showToast('Please select a rating before submitting');
            return;
          }
          // Append feedback to state and persist
          state.feedbacks.push({ rating, comment, ts: Date.now() });
          applyState();
          logActivity('Feedback', `Rating ${rating}`);
          showToast('Thank you for your feedback!');
          // Clear the form
          if (ratingSel) ratingSel.value = '';
          if (commentEl) commentEl.value = '';
        });
      }

      // Local events booking handler
      const eventsListEl = document.getElementById('eventsList');
      if (eventsListEl) {
        eventsListEl.addEventListener('click', (e) => {
          const btn = e.target.closest('button[data-event-id]');
          if (!btn) return;
          const eventId = btn.getAttribute('data-event-id');
          const ev = events.find((x) => x.id === eventId);
          if (!ev) return;
          showToast(`${ev.title} booked! Enjoy your experience.`);
          logActivity('Event booked', ev.title);
        });
      }

      // === PART 5: Wake-up, Reminders & Itinerary Logic ===
      // Global references for scheduling reminders and wake-up calls. We
      // store timeout IDs so they can be cleared if the user cancels or
      // reschedules.
      let wakeTimeoutId = null;
      const reminderTimeouts = {};

      // Render the list of reminders. Each reminder shows the title, due
      // date/time and offers buttons to mark as done or delete. Reminders
      // are sorted by due date ascending. Done reminders are visually
      // distinguished and are not scheduled again.
      function renderReminders() {
        const list = document.getElementById('reminderList');
        if (!list) return;
        list.innerHTML = '';
        // sort reminders by due time
        const sorted = [...state.reminders].sort((a, b) => a.due - b.due);
        sorted.forEach((rem) => {
          const li = document.createElement('li');
          li.className = 'reminder-item';
          const dueDate = new Date(rem.due);
          const dueStr = dueDate.toLocaleString();
          const titleSpan = document.createElement('span');
          titleSpan.textContent = `${rem.title} ‚Äî ${dueStr}`;
          if (rem.done) {
            titleSpan.style.textDecoration = 'line-through';
            titleSpan.style.color = 'var(--fg-muted)';
          }
          li.appendChild(titleSpan);
          // Done button
          const doneBtn = document.createElement('button');
          doneBtn.className = 'btn-secondary';
          doneBtn.textContent = rem.done ? 'Redo' : 'Done';
          doneBtn.addEventListener('click', () => {
            rem.done = !rem.done;
            applyState();
            renderReminders();
            logActivity('Reminder', `${rem.done ? 'Completed' : 'Reopened'} ${rem.title}`);
          });
          li.appendChild(doneBtn);
          // Delete button
          const delBtn = document.createElement('button');
          delBtn.className = 'btn-secondary';
          delBtn.textContent = 'Delete';
          delBtn.addEventListener('click', () => {
            // remove from state
            state.reminders = state.reminders.filter((r) => r.id !== rem.id);
            applyState();
            renderReminders();
            // cancel timeout if scheduled
            if (reminderTimeouts[rem.id]) {
              clearTimeout(reminderTimeouts[rem.id]);
              delete reminderTimeouts[rem.id];
            }
            logActivity('Reminder', `Deleted ${rem.title}`);
          });
          li.appendChild(delBtn);
          list.appendChild(li);
        });
      }

      // Render the itinerary list. Shows event name, date/time and
      // location. Each item can be deleted.
      function renderItinerary() {
        const list = document.getElementById('itineraryList');
        if (!list) return;
        list.innerHTML = '';
        const sorted = [...state.itinerary].sort((a, b) => a.ts - b.ts);
        sorted.forEach((it) => {
          const li = document.createElement('li');
          li.className = 'itinerary-item';
          const dateStr = new Date(it.ts).toLocaleString();
          li.innerHTML = `<span>${it.title} ‚Äî ${dateStr} @ ${it.location}</span>`;
          const delBtn = document.createElement('button');
          delBtn.className = 'btn-secondary';
          delBtn.textContent = 'Delete';
          delBtn.addEventListener('click', () => {
            state.itinerary = state.itinerary.filter((e) => e.id !== it.id);
            applyState();
            renderItinerary();
            logActivity('Itinerary', `Deleted ${it.title}`);
          });
          li.appendChild(delBtn);
          list.appendChild(li);
        });
      }

      // Schedule a wake-up notification based on the current wakeTime in
      // state. Clears any existing timer. Only schedule if the set time
      // is in the future. When triggered, plays a toast and logs the
      // event.
      function scheduleWake() {
        // clear previous timeout
        if (wakeTimeoutId) {
          clearTimeout(wakeTimeoutId);
          wakeTimeoutId = null;
        }
        if (!state.wakeTime) return;
        const now = Date.now();
        const wakeTs = new Date(state.wakeTime).getTime();
        const diff = wakeTs - now;
        if (diff <= 0) return; // past time, do not schedule
        // Only schedule up to 24h ahead to avoid huge timeouts
        if (diff > 24 * 60 * 60 * 1000) return;
        wakeTimeoutId = setTimeout(() => {
          showToast('Wake-up call! Good morning.');
          logActivity('Wake-up', 'Alarm triggered');
          // clear wakeTime after triggering
          state.wakeTime = '';
          applyState();
          scheduleWake();
        }, diff);
      }

      // Schedule notifications for all reminders. Clear existing timers
      // then set a timeout for each upcoming reminder. When due the
      // reminder triggers a toast and marks itself done.
      function scheduleReminders() {
        // clear previous timeouts
        Object.keys(reminderTimeouts).forEach((id) => {
          clearTimeout(reminderTimeouts[id]);
          delete reminderTimeouts[id];
        });
        const now = Date.now();
        state.reminders.forEach((rem) => {
          if (rem.done) return;
          const diff = rem.due - now;
          if (diff <= 0) return;
          if (diff > 24 * 60 * 60 * 1000) return;
          reminderTimeouts[rem.id] = setTimeout(() => {
            showToast(`Reminder: ${rem.title}`);
            rem.done = true;
            applyState();
            renderReminders();
            logActivity('Reminder', `${rem.title} due`);
          }, diff);
        });
      }

      // Wake-up scheduler buttons
      const setWakeBtn = document.getElementById('setWakeBtn');
      const clearWakeBtn = document.getElementById('clearWakeBtn');
      if (setWakeBtn) {
        setWakeBtn.addEventListener('click', () => {
          const timeInput = document.getElementById('wakeTime');
          if (!timeInput) return;
          const selected = timeInput.value;
          if (!selected) {
            showToast('Please select a time for wake-up.');
            return;
          }
          // Convert selected time (HH:MM) to a full datetime today or tomorrow
          const now = new Date();
          const [hh, mm] = selected.split(':');
          const wakeDate = new Date(now.getFullYear(), now.getMonth(), now.getDate(), parseInt(hh, 10), parseInt(mm, 10), 0);
          // If the selected time has already passed today, schedule for tomorrow
          if (wakeDate.getTime() <= now.getTime()) {
            wakeDate.setDate(wakeDate.getDate() + 1);
          }
          state.wakeTime = wakeDate.toISOString();
          applyState();
          scheduleWake();
          showToast('Wake-up call scheduled.');
          logActivity('Wake-up', `Scheduled for ${wakeDate.toLocaleString()}`);
        });
      }
      if (clearWakeBtn) {
        clearWakeBtn.addEventListener('click', () => {
          state.wakeTime = '';
          applyState();
          scheduleWake();
          showToast('Wake-up call cleared.');
          logActivity('Wake-up', 'Cleared');
        });
      }

      // Reminder add button
      const addReminderBtn = document.getElementById('addReminderBtn');
      if (addReminderBtn) {
        addReminderBtn.addEventListener('click', () => {
          const titleEl = document.getElementById('reminderTitle');
          const timeEl = document.getElementById('reminderTime');
          const title = titleEl ? titleEl.value.trim() : '';
          const timeVal = timeEl ? timeEl.value : '';
          if (!title || !timeVal) {
            showToast('Please enter a title and time for the reminder.');
            return;
          }
          const dueTs = new Date(timeVal).getTime();
          if (isNaN(dueTs) || dueTs <= Date.now()) {
            showToast('Please choose a future time for the reminder.');
            return;
          }
          // Create unique ID
          const id = 'r' + Date.now();
          const reminder = { id, title, due: dueTs, done: false };
          state.reminders.push(reminder);
          applyState();
          renderReminders();
          scheduleReminders();
          showToast('Reminder added');
          logActivity('Reminder', `Added ${title}`);
          // Clear fields
          if (titleEl) titleEl.value = '';
          if (timeEl) timeEl.value = '';
        });
      }

      // Itinerary add button
      const addItineraryBtn = document.getElementById('addItineraryBtn');
      if (addItineraryBtn) {
        addItineraryBtn.addEventListener('click', () => {
          const titleEl = document.getElementById('itineraryTitle');
          const timeEl = document.getElementById('itineraryTime');
          const locEl = document.getElementById('itineraryLocation');
          const title = titleEl ? titleEl.value.trim() : '';
          const timeVal = timeEl ? timeEl.value : '';
          const loc = locEl ? locEl.value.trim() : '';
          if (!title || !timeVal || !loc) {
            showToast('Please provide event name, time and location.');
            return;
          }
          const ts = new Date(timeVal).getTime();
          if (isNaN(ts) || ts <= Date.now()) {
            showToast('Please choose a future date/time for the event.');
            return;
          }
          const id = 'it' + Date.now();
          const entry = { id, title, ts, location: loc };
          state.itinerary.push(entry);
          applyState();
          renderItinerary();
          showToast('Itinerary event added');
          logActivity('Itinerary', `Added ${title}`);
          // Clear inputs
          if (titleEl) titleEl.value = '';
          if (timeEl) timeEl.value = '';
          if (locEl) locEl.value = '';
        });
      }

      // Function to initialise all part 5 features on page load. This
      // renders lists and schedules notifications based on persisted
      // state.
      function initPart5() {
        renderReminders();
        renderItinerary();
        scheduleWake();
        scheduleReminders();
      }

      // === PART 6: Dashboard (KPI) Logic ===
      // List of daily tips. The tip of the day is selected deterministically
      // based on the day of the year so all guests see the same tip on a
      // given day. Feel free to expand this list with more hospitality
      // insights, fun facts or inspirational quotes.
      const dailyTips = [
        'Remember to stay hydrated throughout your travels.',
        'Explore a new local caf√© today for a taste of the city.',
        'Take a mindful moment to appreciate your surroundings.',
        'Ask our concierge about hidden gems off the beaten path.',
        'A good night‚Äôs sleep is the best travel companion.',
        'Pack light ‚Äì souvenirs are more fun than suitcases!',
        'Capture memories, not just photos.',
        'Try a dish you‚Äôve never had before.',
        'Leave room in your schedule for spontaneity.',
        'Kindness is a universal language ‚Äì share it freely.',
      ];

      // Compute the current tip based on the day of year
      function getDailyTip() {
        const start = new Date(new Date().getFullYear(), 0, 0);
        const diff = (Date.now() - start) + (start.getTimezoneOffset() * 60 * 1000);
        const day = Math.floor(diff / (1000 * 60 * 60 * 24));
        return dailyTips[day % dailyTips.length];
      }

      // Update dashboard KPI values. Called on interval and when certain
      // state values change (e.g. orders, checkout date, home timezone).
      function updateClocks() {
        const localTimeEl = document.getElementById('localTimeValue');
        const homeTimeEl = document.getElementById('homeTimeValue');
        const daysLeftEl = document.getElementById('daysLeftValue');
        const totalSpendEl = document.getElementById('totalSpendValue');
        if (!localTimeEl || !homeTimeEl || !daysLeftEl || !totalSpendEl) return;
        const now = new Date();
        // Local time
        localTimeEl.textContent = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        // Home time (convert via locale string and timeZone)
        try {
          const homeString = now.toLocaleString('en-US', { timeZone: state.homeTz });
          const homeDate = new Date(homeString);
          homeTimeEl.textContent = homeDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        } catch (e) {
          // Fallback if timezone invalid
          homeTimeEl.textContent = '--:--:--';
        }
        // Days left until checkout
        const checkoutDate = new Date(state.checkout);
        const diffMs = checkoutDate.getTime() - now.getTime();
        const daysLeft = Math.max(0, Math.ceil(diffMs / (24 * 60 * 60 * 1000)));
        daysLeftEl.textContent = String(daysLeft);
        // Total spend across orders in selected currency
        const rate = currencyRates[state.currency] || 1;
        const symbol = currencySymbols[state.currency] || '';
        let total = 0;
        state.orders.forEach((item) => {
          total += item.price * rate;
        });
        totalSpendEl.textContent = `${symbol}${total.toFixed(2)}`;

        // Additional KPIs: active reminders and itinerary items
        const remindersEl = document.getElementById('remindersValue');
        const itineraryEl = document.getElementById('itineraryValue');
        if (remindersEl) {
          // Count only reminders that are not marked done
          const count = Array.isArray(state.reminders)
            ? state.reminders.filter((r) => !r.done).length
            : 0;
          remindersEl.textContent = String(count);
        }
        if (itineraryEl) {
          const count = Array.isArray(state.itinerary) ? state.itinerary.length : 0;
          itineraryEl.textContent = String(count);
        }
      }

      // Set the daily tip text
      function renderDailyTip() {
        const tipEl = document.getElementById('dailyTipText');
        if (!tipEl) return;
        tipEl.textContent = getDailyTip();
      }

      // Attempt to fetch real-time currency rates if network features are
      // enabled. Updates the currencyRates object and refreshes menus,
      // orders and folio with the new values. If the request fails or
      // network is disabled, the static placeholder rates remain.
      async function fetchCurrencyRates() {
        if (!state.network) return;
        try {
          const res = await fetch('https://api.exchangerate.host/latest?base=EUR');
          if (!res.ok) throw new Error('HTTP error');
          const data = await res.json();
          if (data && data.rates) {
            currencyRates.USD = data.rates.USD || currencyRates.USD;
            currencyRates.GBP = data.rates.GBP || currencyRates.GBP;
            renderMenu();
            renderOrders();
            renderFolio();
            updateClocks();
            showToast('Currency rates updated');
            logActivity('Currency', 'Rates refreshed');
          }
        } catch (err) {
          console.warn('Failed to fetch currency rates', err);
        }
      }

      // Interval for clocks
      let clockInterval;
      function startClock() {
        if (clockInterval) clearInterval(clockInterval);
        updateClocks();
        clockInterval = setInterval(updateClocks, 1000);
      }

      renderMenu();
      renderOrders();
      renderMap();
      renderFolio();
      renderNotifications();
      renderActivity();
      renderRoomControls();
      renderEvents();
      renderNews();
      renderShuttle();
      // Reapply state to update all UI elements based on persisted values
      applyState();

      // Initialise new features (wake-up, reminders, itinerary)
      initPart5();

      // Initialise dashboard: render the daily tip and start the clock updates
      renderDailyTip();
      startClock();

      // Fetch currency rates if network is enabled. Do this after
      // initialisation so the UI is populated before any asynchronous
      // operations. The service worker caches this fetch when available.
      fetchCurrencyRates();

      // Register a service worker for offline support. The service worker
      // caches the application shell and assets so the concierge app
      // continues to function even when the network is unavailable.
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker
            .register('sw.js')
            .catch((err) => console.error('ServiceWorker registration failed', err));
        });
      }

      // Make the chat container draggable by the chat header. Users can
      // reposition the chat anywhere on the screen by dragging. We only
      // track the horizontal and vertical offset relative to the current
      // viewport. The container‚Äôs left and top CSS properties are
      // updated accordingly. This does not affect its fixed positioning
      // semantics.
      (function enableChatDrag() {
        const header = document.querySelector('.chat-header');
        let dragging = false;
        let startX = 0;
        let startY = 0;
        let startLeft = 0;
        let startTop = 0;
        if (!header) return;
        header.addEventListener('mousedown', (e) => {
          dragging = true;
          startX = e.clientX;
          startY = e.clientY;
          const rect = chatContainer.getBoundingClientRect();
          startLeft = rect.left;
          startTop = rect.top;
          // prevent text selection
          e.preventDefault();
        });
        document.addEventListener('mousemove', (e) => {
          if (!dragging) return;
          const dx = e.clientX - startX;
          const dy = e.clientY - startY;
          chatContainer.style.right = 'auto';
          chatContainer.style.left = `${startLeft + dx}px`;
          chatContainer.style.top = `${Math.max(startTop + dy, 0)}px`;
        });
        document.addEventListener('mouseup', () => {
          dragging = false;
        });
      })();

      // Bottom navigation functionality. When a nav button is clicked,
      // scroll smoothly to the associated section and update the active
      // class for visual feedback.
      (function initBottomNav() {
        const nav = document.getElementById('bottomNav');
        if (!nav) return;
        const buttons = nav.querySelectorAll('button');
        buttons.forEach((btn) => {
          btn.addEventListener('click', () => {
            buttons.forEach((b) => b.classList.remove('active'));
            btn.classList.add('active');
            const targetId = btn.getAttribute('data-target');
            const targetEl = document.getElementById(targetId);
            if (targetEl) {
              targetEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
          });
        });
      })();

      // Chat agent selector functionality. Updates the active agent and
      // chat title. Clears current conversation when switching for a
      // distinct experience per agent.
      (function initChatAgents() {
        const agentsEl = document.getElementById('chatAgents');
        if (!agentsEl) return;
        const titleEl = document.getElementById('chatTitle');
        const btns = agentsEl.querySelectorAll('button');
        btns.forEach((btn) => {
          btn.addEventListener('click', () => {
            btns.forEach((b) => b.classList.remove('active'));
            btn.classList.add('active');
            activeAgent = btn.dataset.agent;
            // Update chat title to include the MORPHO brand
            if (titleEl) titleEl.textContent = `MORPHO ‚Äì ${btn.textContent}`;
            // Clear chat log for new agent
            if (chatLog) chatLog.innerHTML = '';
            // Greet user differently depending on agent
            const greetings = {
              concierge: 'Hello! I‚Äôm MORPHO, your concierge AI. How may I assist you?',
              explorer: 'Hi! I‚Äôm MORPHO, your explorer guide. Ready for an adventure?',
              support: 'Hello! I‚Äôm MORPHO from support. How can I help resolve your issue?'
            };
            appendMessage(greetings[activeAgent] || 'Hello!', 'bot');
          });
        });
      })();
    </script>
  </body>
</html>
